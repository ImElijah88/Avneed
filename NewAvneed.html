<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avneed - Your Personal AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/pmrem/PMREMGenerator.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInWithPopup, GithubAuthProvider, GoogleAuthProvider, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token (Canvas environment).");
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                    }
                } else {
                    // Sign in anonymously if no custom token is provided (for local development/testing)
                    try {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously (no custom token).");
                    } catch (error) {
                        console.error("Error signing in anonymously:", error);
                    }
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User is logged in:", userId);
                        updateLoginButtons(true, user.isAnonymous); // Pass isAnonymous status
                        loadUserNotes();
                    } else {
                        userId = null;
                        console.log("User is logged out.");
                        updateLoginButtons(false, false);
                        // Clear notes and status if user logs out
                        const userNotesInput = document.getElementById('userNotesInput');
                        const userNotesStatus = document.getElementById('userNotesStatus');
                        if (userNotesInput) userNotesInput.value = '';
                        if (userNotesStatus) userNotesStatus.textContent = translations[currentLanguage].notesLoginStatus;
                    }
                });
            } else {
                console.warn("Firebase config not found. Firebase features will be disabled.");
                // Disable login/logout/notes features if Firebase is not configured
                const loginBtnModalGoogle = document.getElementById('loginBtnModalGoogle');
                const loginBtnModalGithub = document.getElementById('loginBtnModalGithub');
                const loginBtnModalGuest = document.getElementById('loginBtnModalGuest');
                const logoutBtnModal = document.getElementById('logoutBtnModal');
                const saveNotesBtn = document.getElementById('saveNotesBtn');
                const userNotesInput = document.getElementById('userNotesInput');
                const userNotesStatus = document.getElementById('userNotesStatus');

                if (loginBtnModalGoogle) loginBtnModalGoogle.disabled = true;
                if (loginBtnModalGithub) loginBtnModalGithub.disabled = true;
                if (loginBtnModalGuest) loginBtnModalGuest.disabled = true;
                if (logoutBtnModal) logoutBtnModal.disabled = true;
                if (saveNotesBtn) saveNotesBtn.disabled = true;
                if (userNotesInput) userNotesInput.disabled = true;
                if (userNotesStatus) userNotesStatus.textContent = translations[currentLanguage].firebaseNotInit;
            }
        });

        window.loginWithGitHub = async () => {
            const provider = new GithubAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                console.log("Signed in with GitHub!");
                closeModal(); // Close modal after successful login
            } catch (error) {
                console.error("Error signing in with GitHub:", error);
            }
        };

        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                console.log("Signed in with Google!");
                closeModal(); // Close modal after successful login
            } catch (error) {
                console.error("Error signing in with Google:", error);
            }
        };

        window.signInAsGuest = async () => {
            try {
                await signInAnonymously(auth);
                console.log("Signed in as Guest!");
                closeModal(); // Close modal after successful login
            } catch (error) {
                console.error("Error signing in anonymously:", error);
            }
        };

        window.logoutUser = async () => {
            try {
                await signOut(auth);
                console.log("User signed out.");
                closeModal(); // Close modal after successful logout
            } catch (error) {
                console.error("Error signing out:", error);
            }
        };

        window.saveUserNotes = async () => {
            if (!userId) {
                const userNotesStatus = document.getElementById('userNotesStatus');
                if (userNotesStatus) userNotesStatus.textContent = translations[currentLanguage].notesLoginStatus;
                return;
            }
            if (!db) {
                const userNotesStatus = document.getElementById('userNotesStatus');
                if (userNotesStatus) userNotesStatus.textContent = translations[currentLanguage].firebaseNotInit;
                return;
            }

            const userNotes = document.getElementById('userNotesInput').value;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private`, 'notes');

            try {
                await setDoc(userDocRef, { content: userNotes, timestamp: new Date() }, { merge: true });
                const userNotesStatus = document.getElementById('userNotesStatus');
                if (userNotesStatus) userNotesStatus.textContent = translations[currentLanguage].notesSavedSuccess;
                console.log("User notes saved.");
            } catch (error) {
                console.error("Error saving notes:", error);
                const userNotesStatus = document.getElementById('userNotesStatus');
                if (userNotesStatus) userNotesStatus.textContent = `${translations[currentLanguage].notesSaveError} ${error.message}`;
            }
        };

        window.loadUserNotes = () => {
            if (!userId || !db) {
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private`, 'notes');
            const userNotesInput = document.getElementById('userNotesInput');
            const userNotesStatus = document.getElementById('userNotesStatus');

            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (userNotesInput) userNotesInput.value = data.content || '';
                    if (userNotesStatus) userNotesStatus.textContent = translations[currentLanguage].notesLoaded;
                } else {
                    if (userNotesInput) userNotesInput.value = '';
                    if (userNotesStatus) userNotesStatus.textContent = translations[currentLanguage].noNotesFound;
                }
                console.log("User notes loaded/updated from Firestore.");
            }, (error) => {
                console.error("Error loading notes:", error);
                if (userNotesStatus) userNotesStatus.textContent = `${translations[currentLanguage].notesLoadError} ${error.message}`;
            });
        };

        window.updateLoginButtons = (isLoggedIn, isAnonymous = false) => {
            const loginBtnModalGoogle = document.getElementById('loginBtnModalGoogle');
            const loginBtnModalGithub = document.getElementById('loginBtnModalGithub');
            const loginBtnModalGuest = document.getElementById('loginBtnModalGuest');
            const logoutBtnModal = document.getElementById('logoutBtnModal');
            const userNotesInput = document.getElementById('userNotesInput');
            const saveNotesBtn = document.getElementById('saveNotesBtn');

            if (isLoggedIn) {
                if (loginBtnModalGoogle) loginBtnModalGoogle.classList.add('hidden');
                if (loginBtnModalGithub) loginBtnModalGithub.classList.add('hidden');
                if (loginBtnModalGuest) loginBtnModalGuest.classList.add('hidden');
                if (logoutBtnModal) logoutBtnModal.classList.remove('hidden');
            } else {
                if (loginBtnModalGoogle) loginBtnModalGoogle.classList.remove('hidden');
                if (loginBtnModalGithub) loginBtnModalGithub.classList.remove('hidden');
                if (loginBtnModalGuest) loginBtnModalGuest.classList.remove('hidden');
                if (logoutBtnModal) logoutBtnModal.classList.add('hidden');
            }
            // Enable/disable notes input and save button based on login status
            if (userNotesInput) userNotesInput.disabled = !isLoggedIn;
            if (saveNotesBtn) saveNotesBtn.disabled = !isLoggedIn;
        };
    </script>

    <style>
        :root {
            --bg-primary: #333333;
            --bg-secondary: #1a1a2e;
            --bg-card: #121212;
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-light-gray: #a0aec0;
            --border-color: #4a5568;
            --input-bg: #1a1a1a;
            --gradient-start: #0f172a;
            --gradient-mid: #1e293b;
            --gradient-end: #334155;
            --color-neon-blue: #00FFFF;
            --color-accent-yellow: #ffd700;
            --modal-bg: rgba(0, 0, 0, 0.8);
            --modal-content-bg: var(--bg-secondary);
        }

        body.light-theme {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-card: #e2e8f0;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-light-gray: #718096;
            --border-color: #cbd5e1;
            --input-bg: #ffffff;
            --gradient-start: #e0e7ff;
            --gradient-mid: #c3dafe;
            --gradient-end: #a7c5ff;
            --color-neon-blue: #007bff;
            --color-accent-yellow: #ff9800;
            --modal-bg: rgba(255, 255, 255, 0.8);
            --modal-content-bg: var(--bg-secondary);
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .text-neon-blue {
            color: var(--color-neon-blue);
        }
        .gradient-bg {
            background: linear-gradient(to right top, var(--gradient-start), var(--gradient-mid), var(--gradient-end));
        }
        .btn-primary {
            @apply px-10 py-4 rounded-full text-white font-bold text-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105;
            background: #2d3748;
            border: 2px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        .btn-primary:hover {
            background: #374151;
            box-shadow: 0 0 25px 8px rgba(255, 215, 0, 0.7), 0 0 10px 2px rgba(255, 215, 0, 0.4);
            border-color: var(--color-accent-yellow);
        }

        .ai-button {
            @apply px-6 py-3 rounded-full text-white font-bold text-base shadow-lg transition duration-300 ease-in-out transform hover:scale-105;
            background: #2d3748;
            border: 2px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        .ai-button:hover {
            background: #374151;
            box-shadow: 0 0 25px 8px rgba(255, 215, 0, 0.7), 0 0 10px 2px rgba(255, 215, 0, 0.4);
            border-color: var(--color-accent-yellow);
        }

        .ai-button.selected-button {
            background: var(--color-neon-blue);
            color: var(--bg-primary);
            border-color: var(--color-neon-blue);
            box-shadow: 0 0 20px var(--color-neon-blue), 0 0 30px var(--color-neon-blue);
            transform: scale(1.02);
        }
        .ai-button.selected-button:hover {
            background: var(--color-neon-blue);
            color: var(--bg-primary);
            box-shadow: 0 0 25px var(--color-neon-blue), 0 0 40px var(--color-neon-blue);
            border-color: var(--color-neon-blue);
        }

        .sphere-button {
            @apply w-20 h-20 rounded-full flex items-center justify-center text-white font-bold text-base shadow-lg transition duration-300 ease-in-out transform hover:scale-110;
            background: #2d3748;
            border: 2px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            flex-shrink: 0;
        }
        .sphere-button:hover {
            background: #374151;
            box-shadow: 0 0 25px 8px rgba(255, 215, 0, 0.7), 0 0 10px 2px rgba(255, 215, 0, 0.4);
            border-color: var(--color-accent-yellow);
        }
        /* Specific hover for neon blue as requested */
        .sphere-button.neon-hover:hover {
            background: var(--color-neon-blue);
            color: var(--bg-primary);
            box-shadow: 0 0 25px 8px rgba(0, 255, 255, 0.7), 0 0 10px 2px rgba(0, 255, 255, 0.4);
            border-color: var(--color-neon-blue);
        }


        .card {
            background-color: var(--bg-card);
            @apply p-8 rounded-[2.5rem] shadow-xl transition duration-300 ease-in-out hover:shadow-2xl hover:translate-y-[-5px];
            border: 1px solid rgba(74, 85, 104, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }
        .input-field {
            background-color: var(--input-bg);
            color: var(--text-primary);
            @apply p-4 rounded-2xl border border-gray-700 focus:outline-none focus:ring-4 focus:ring-purple-600 transition duration-200 ease-in-out;
            border-color: var(--border-color);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--color-accent-yellow);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .text-gray-100 { color: var(--text-primary); }
        .text-gray-200 { color: var(--text-secondary); }
        .text-gray-300 { color: var(--text-light-gray); }
        .text-gray-400 { color: var(--text-light-gray); }
        .text-gray-500 { color: var(--text-light-gray); }
        .text-gray-700 { border-color: var(--border-color); }
        .bg-gray-800 { background-color: var(--bg-card); }
        .bg-gray-900 { background-color: var(--bg-secondary); }
        .bg-gray-950 { background-color: var(--bg-card); }
        .bg-[#1a1a1a] { background-color: var(--input-bg); }

        .text-yellow-400 { color: var(--color-accent-yellow); }


        .model-viewer-container {
            position: relative;
            width: 100%;
            height: 450px;
            background-color: transparent;
            border-radius: 2.5rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .model-viewer-canvas {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 2.5rem;
        }
        .model-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--color-accent-yellow);
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
            z-index: 10;
        }
        .model-file-input-label {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 50px;
            height: 50px;
            background: #2d3748;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            color: var(--text-primary);
            cursor: pointer;
            z-index: 15;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        .model-file-input-label:hover {
            background: #374151;
            color: var(--color-neon-blue);
            box-shadow: 0 0 25px 8px rgba(var(--color-neon-blue), 0.7), 0 0 10px 2px rgba(var(--color-neon-blue), 0.4);
            border-color: var(--color-neon-blue);
            transform: scale(1.1);
        }
        .hidden-file-input {
            display: none !important;
            width: 0;
            height: 0;
            overflow: hidden;
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background-color: rgba(0, 255, 255, 0.5);
            border-radius: 0 0 2.5rem 0;
            cursor: nwse-resize;
            z-index: 20;
        }

        .contact-content-wrapper {
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
            align-items: center;
        }
        .contact-buttons-wrapper { /* New wrapper for the two new buttons */
            display: flex;
            flex-direction: row;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem; /* Space from the form/model viewer */
            width: 100%; /* Ensure it takes full width to center effectively */
            max-width: 600px; /* Match form max-width for alignment */
            margin-left: auto; /* Center it */
            margin-right: auto; /* Center it */
        }


        @media (min-width: 1024px) {
            .contact-content-wrapper {
                flex-direction: row;
                justify-content: center;
                align-items: flex-start;
            }
            .contact-form-container {
                flex: 1;
                max-width: 45%;
            }
            .new-model-viewer-area {
                flex: 1;
                max-width: 45%;
            }
        }

        .model-controls {
            position: absolute;
            bottom: 1.5rem;
            left: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            z-index: 15;
            background: rgba(45, 55, 72, 0.7);
            padding: 0.5rem;
            border-radius: 1rem;
            border: 1px solid rgba(74, 85, 104, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .model-control-button {
            @apply px-1 py-0.5 rounded-md text-white font-bold text-xs transition duration-300 ease-in-out transform hover:scale-105;
            background: #2d3748;
            border: 1px solid #4a5568;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .model-control-button:hover {
            background: #374151;
            color: var(--color-neon-blue);
            box-shadow: 0 0 10px 3px rgba(var(--color-neon-blue), 0.5);
            border-color: var(--color-neon-blue);
        }
        .model-controls .grid-cols-3 .model-control-button {
            width: 30px;
            height: 30px;
            font-size: 1rem;
        }
        .model-control-button.toggle-lock {
            width: 100%;
        }

        .upload-menu {
            position: absolute;
            top: 65px;
            right: 1.5rem;
            background: rgba(45, 55, 72, 0.9);
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px solid rgba(74, 85, 104, 0.3);
        }

        .upload-menu-button {
            @apply px-4 py-2 rounded-md text-white font-bold text-sm transition duration-300 ease-in-out transform hover:scale-105;
            background: #2d3748;
            border: 1px solid #4a5568;
            cursor: pointer;
        }
        .upload-menu-button:hover {
            background: #374151;
            color: var(--color-neon-blue);
            box-shadow: 0 0 10px 3px rgba(var(--color-neon-blue), 0.5);
            border-color: var(--color-neon-blue);
        }

        .audio-controls {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            width: 50px;
            height: 50px;
            background: #2d3748;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            color: var(--text-primary);
            cursor: pointer;
            z-index: 15;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        .audio-controls:hover {
            background: #374151;
            color: var(--color-neon-blue);
            box-shadow: 0 0 25px 8px rgba(var(--color-neon-blue), 0.7), 0 0 10px 2px rgba(var(--color-neon-blue), 0.4);
            border-color: var(--color-neon-blue);
            transform: scale(1.1);
        }
        .audio-play-pause-button {
            background: none;
            border: none;
            color: inherit;
            font-size: inherit;
            cursor: inherit;
            padding: 0;
            margin: 0;
            line-height: 1;
        }

        #settingsBtn {
            @apply text-3xl cursor-pointer transition duration-300 ease-in-out transform hover:rotate-90 hover:text-yellow-300;
        }

        .settings-menu {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(45, 55, 72, 0.95);
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            border: 1px solid rgba(74, 85, 104, 0.5);
        }

        .settings-menu-button {
            @apply px-4 py-2 rounded-md text-white font-bold text-sm transition duration-300 ease-in-out transform hover:scale-105;
            background: #2d3748;
            border: 1px solid #4a5568;
            cursor: pointer;
            width: 100%;
            text-align: left;
        }
        .settings-menu-button:hover {
            background: #374151;
            color: var(--color-neon-blue);
            box-shadow: 0 0 10px 3px rgba(var(--color-neon-blue), 0.5);
            border-color: var(--color-neon-blue);
        }

        #chatHistory p {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.75rem;
            max-width: 75%;
        }

        #chatHistory p.user-message {
            margin-left: auto;
            background-color: var(--color-neon-blue);
            color: var(--bg-primary);
            font-weight: 600;
            border-bottom-right-radius: 0.25rem;
        }
        #chatHistory p.ai-message {
            margin-right: auto;
            background-color: var(--bg-card);
            color: var(--text-primary);
            border-bottom-left-radius: 0.25rem;
        }

        #aiInputText, #imagePromptInput, #videoPromptInput, #userNotesInput {
            min-height: 2.5rem;
            max-height: 152px;
            overflow-y: hidden;
            box-sizing: border-box;
        }

        .glitch-text {
            animation: glitch 0.8s linear infinite alternate, neon-pulse 0.8s ease-in-out forwards;
        }

        @keyframes glitch {
            0% {
                text-shadow: 0.05em 0 0 var(--color-neon-blue), -0.05em -0.025em 0 var(--color-accent-yellow), -0.025em 0.05em 0 var(--color-neon-blue);
                transform: translate(0.01em, 0.01em);
            }
            15% {
                text-shadow: 0.025em 0.05em 0 var(--color-accent-yellow), -0.025em -0.01em 0 var(--color-neon-blue), 0.05em -0.025em 0 var(--color-accent-yellow);
                transform: translate(-0.01em, -0.02em);
            }
            30% {
                text-shadow: -0.025em -0.05em 0 var(--color-neon-blue), 0.05em 0.025em 0 var(--color-accent-yellow), 0.01em 0.01em 0 var(--color-neon-blue);
                transform: translate(0.02em, 0.01em);
            }
            45% {
                text-shadow: 0.05em 0.01em 0 var(--color-accent-yellow), -0.01em -0.05em 0 var(--color-neon-blue), -0.05em 0.025em 0 var(--color-accent-yellow);
                transform: translate(-0.01em, -0.01em);
            }
            60% {
                text-shadow: -0.01em -0.025em 0 var(--color-neon-blue), 0.025em 0.05em 0 var(--color-accent-yellow), 0.05em -0.01em 0 var(--color-neon-blue);
                transform: translate(0.01em, 0.02em);
            }
            75% {
                text-shadow: 0.025em 0.01em 0 var(--color-accent-yellow), -0.05em -0.025em 0 var(--color-neon-blue), -0.01em 0.05em 0 var(--color-accent-yellow);
                transform: translate(-0.02em, 0.01em);
            }
            100% {
                color: var(--text-primary);
                text-shadow: none;
                transform: scale(1);
            }
        }

        @keyframes neon-pulse {
            0% {
                color: var(--text-primary);
                text-shadow: none;
                transform: scale(1);
            }
            50% {
                color: var(--color-neon-blue);
                text-shadow: 0 0 10px var(--color-neon-blue), 0 0 20px var(--color-neon-blue), 0 0 30px var(--color-neon-blue);
                transform: scale(1.02);
            }
            100% {
                color: var(--text-primary);
                text-shadow: none;
                transform: scale(1);
            }
        }

        .audio-play-toggle-btn {
            @apply w-16 h-16 rounded-full flex items-center justify-center text-3xl transition duration-300 ease-in-out transform hover:scale-110;
            background: #2d3748;
            border: 2px solid var(--border-color);
            color: var(--color-neon-blue);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            cursor: pointer;
        }
        .audio-play-toggle-btn:hover {
            background: #374151;
            box-shadow: 0 0 25px 8px rgba(var(--color-neon-blue), 0.7), 0 0 10px 2px rgba(var(--color-neon-blue), 0.4);
            border-color: var(--color-neon-blue);
        }

        .image-frame-container {
            background-color: var(--bg-card);
            border: 5px solid var(--color-neon-blue);
            border-radius: 1.5rem;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.6),
                        0 0 30px rgba(0, 255, 255, 0.4) inset,
                        0 15px 30px rgba(0, 0, 0, 0.7);
            padding: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease-in-out;
            transform: rotateZ(-1deg);
            max-width: 100%;
            margin: 0 auto;
            animation: neon-pulse-frame 2s infinite alternate;
        }

        @keyframes neon-pulse-frame {
            0% {
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.6),
                            0 0 30px rgba(0, 255, 255, 0.4) inset,
                            0 15px 30px rgba(0, 0, 0, 0.7);
            }
            100% {
                box-shadow: 0 0 25px rgba(0, 255, 255, 0.9),
                            0 0 40px rgba(0, 255, 255, 0.6) inset,
                            0 15px 30px rgba(0, 0, 0, 0.9);
            }
        }

        .image-frame-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: repeating-linear-gradient(0deg, rgba(0, 255, 255, 0.05) 0px, rgba(0, 255, 255, 0.05) 1px, transparent 1px, transparent 20px),
                              repeating-linear-gradient(90deg, rgba(0, 255, 255, 0.05) 0px, rgba(0, 255, 255, 0.05) 1px, transparent 1px, transparent 20px);
            pointer-events: none;
            z-index: 1;
            border-radius: 1rem;
        }

        .generated-image {
            position: relative;
            z-index: 2;
        }

        .image-frame-container.aspect-1-1 {
            width: 400px;
            height: 400px;
        }

        .image-frame-container.aspect-16-9 {
            width: 640px;
            height: 360px;
        }

        .image-frame-container.aspect-4-3 {
            width: 500px;
            height: 375px;
        }
        .image-frame-container.aspect-9-16 {
            width: 360px;
            height: 640px;
        }

        @media (max-width: 768px) {
            .image-frame-container.aspect-1-1 {
                width: 300px;
                height: 300px;
            }
            .image-frame-container.aspect-16-9 {
                width: 90%;
                height: calc(90vw * 9 / 16);
                max-height: 300px;
            }
            .image-frame-container.aspect-4-3 {
                width: 90%;
                height: calc(90vw * 3 / 4);
                max-height: 300px;
            }
            .image-frame-container.aspect-9-16 {
                width: calc(90vw * 9 / 16);
                height: 90vw;
                max-width: 200px;
                max-height: 350px;
            }
        }

        .generated-image {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5) inset;
            transition: opacity 0.3s ease-in-out;
        }

        .image-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
            border-radius: 1rem;
            z-index: 10;
        }

        .image-loading-spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid var(--color-neon-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .video-player-container {
            background-color: var(--bg-card);
            border: 5px solid var(--color-neon-blue);
            border-radius: 1.5rem;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.6),
                        0 0 30px rgba(0, 255, 255, 0.4) inset,
                        0 15px 30px rgba(0, 0, 0, 0.7);
            padding: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease-in-out;
            transform: rotateZ(1deg);
            max-width: 100%;
            margin: 0 auto;
            animation: neon-pulse-frame 2s infinite alternate;
        }

        .generated-video {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5) inset;
            transition: opacity 0.3s ease-in-out;
        }

        .video-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
            border-radius: 1rem;
            z-index: 10;
        }

        .video-loading-spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid var(--color-neon-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--modal-content-bg);
            padding: 1.5rem;
            border-radius: 2rem;
            max-width: 600px; /* Reduced max-width for smaller modal */
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-50px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative; /* For close button positioning */
        }

        .modal-overlay.visible .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-close-button {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            z-index: 1010;
        }
        .modal-close-button:hover {
            background: var(--color-neon-blue);
            color: var(--bg-primary);
            border-color: var(--color-neon-blue);
            transform: scale(1.1);
        }

        .ai-feature-content h2 {
            font-size: 2.2rem; /* Adjusted font size for modal */
            margin-bottom: 1.5rem;
        }

        .ai-feature-content p {
            font-size: 0.9rem; /* Smaller text for minimalist feel */
            margin-bottom: 1rem;
        }

        .ai-feature-content .card {
            padding: 1.5rem;
            border-radius: 1.5rem;
        }
        .ai-feature-content .input-field {
            font-size: 0.9rem; /* Smaller font in input fields */
            padding: 0.75rem; /* Smaller padding */
        }
        .ai-feature-content #chatHistory p {
            font-size: 0.85rem; /* Smaller chat history text */
            padding: 0.6rem;
            margin-bottom: 0.3rem;
        }
        .ai-feature-content .loading-spinner {
            width: 25px;
            height: 25px;
        }
        .ai-feature-content .ai-button {
            font-size: 0.85rem; /* Smaller button text */
            padding: 0.6rem 1rem;
        }

        /* Responsive adjustments for modal content */
        @media (max-width: 640px) {
            .modal-content {
                max-width: 95%;
                padding: 1rem;
                border-radius: 1.5rem;
            }
            .ai-feature-content h2 {
                font-size: 1.8rem;
            }
            .ai-feature-content p {
                font-size: 0.8rem;
            }
            .ai-feature-content .input-field {
                font-size: 0.8rem;
            }
            .ai-feature-content #chatHistory p {
                font-size: 0.75rem;
            }
            .ai-feature-content .ai-button {
                font-size: 0.75rem;
                padding: 0.5rem 0.8rem;
            }
        }

    </style>
</head>
<body>
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto flex justify-between items-center px-6">
            <h1 class="text-4xl font-extrabold tracking-tight text-neon-blue">Avneed</h1>
            <nav class="flex items-center space-x-8 text-lg font-semibold">
                <ul class="flex space-x-8">
                    <li><a href="#vision" class="hover:text-yellow-300 transition duration-300 transform hover:scale-105">Vision</a></li>
                    <li><a href="#capabilities" class="hover:text-yellow-300 transition duration-300 transform hover:scale-105">Capabilities</a></li>
                    <li><a href="#ai-features" class="hover:text-yellow-300 transition duration-300 transform hover:scale-105">AI Features</a></li>
                    <li><a href="#contact" class="hover:text-yellow-300 transition duration-300 transform hover:scale-105">Contact</a></li>
                </ul>
                <button id="settingsBtn" class="ml-4">⚙️</button>
            </nav>
        </div>
        <div id="settingsMenu" class="settings-menu hidden">
            <button class="settings-menu-button" data-theme="dark">Dark Theme</button>
            <button class="settings-menu-button" data-theme="light">Light Theme</button>
            <div class="border-t border-gray-600 my-2"></div>
            <p class="text-gray-400 text-sm px-2" id="languageSettingLabel">Language</p>
            <button class="settings-menu-button" data-lang="en">English</button>
        </div>
    </header>

    <section class="gradient-bg text-white py-24 px-6 text-center overflow-hidden relative">
        <div class="container mx-auto relative z-10">
            <h2 id="heroHeading" class="text-6xl font-extrabold leading-tight mb-8 drop-shadow-lg">
                Empower Your Workflow with <span class="text-neon-blue">Avneed</span>
            </h2>
            <p id="heroSubheading" class="text-2xl mb-12 max-w-4xl mx-auto opacity-90">
                The proactive, omnipresent AI assistant designed to seamlessly integrate with your digital life, providing intelligent support across all your devices.
            </p>
            <button class="btn-primary" id="discoverAvneedBtn">Discover <span class="text-neon-blue">Avneed</span></button>
            
            <div id="mainAudioPlayerContainer" class="hidden mt-8">
                <button id="mainAudioPlayToggle" class="audio-play-toggle-btn">▶</button>
            </div>
            <audio id="mainHeroAudio" src="https://imelijah88.github.io/Avneed/live1day.mp3" preload="auto"></audio>

        </div>
        <div class="absolute inset-0 z-0 opacity-20">
            <div class="absolute top-1/4 left-1/4 w-48 h-48 bg-gray-700 rounded-full mix-blend-overlay animate-pulse-slow"></div>
            <div class="absolute bottom-1/3 right-1/4 w-64 h-64 bg-gray-700 rounded-full mix-blend-overlay animate-pulse-slow delay-1000"></div>
        </div>
    </section>

    <section id="vision" class="py-20 px-6 bg-[#1a1a2e] shadow-inner">
        <div class="container mx-auto text-center">
            <h3 id="visionTitle" class="text-5xl font-bold mb-16 text-gray-100 leading-tight">Our Vision: A Transformative Companion</h3>
            <div class="flex flex-col lg:flex-row items-center justify-center lg:space-x-16">
                <div class="lg:w-1/2 mb-12 lg:mb-0">
                    <div id="modelContainer" class="model-viewer-container">
                        <canvas id="modelCanvas" class="model-viewer-canvas"></canvas>
                        <div id="modelStatus" class="model-status hidden">
                            <div class="loading-spinner mb-4"></div>
                            <p>Loading 3D Model...</p>
                        </div>
                        <label for="modelFileInput" id="modelFileInputLabel" class="model-file-input-label">+</label>
                        <input type="file" id="modelFileInput" accept=".gltf, .glb" class="hidden-file-input">
                        <input type="file" id="audioFileInput" accept=".mp3" class="hidden-file-input">

                        <div id="uploadMenu" class="upload-menu hidden">
                            <button class="upload-menu-button" data-type="model">Upload 3D Model</button>
                            <button class="upload-menu-button" data-type="audio">Upload MP3</button>
                        </div>

                        <div id="audioControls" class="audio-controls hidden">
                            <button class="audio-play-pause-button" data-action="play-pause">▶</button>
                        </div>
                        <audio id="primaryAudioPlayer" class="hidden"></audio>


                        <div id="resizeHandle" class="resize-handle"></div>
                        <div id="modelControls" class="model-controls hidden">
                            <div class="grid grid-cols-3 gap-1">
                                <div></div>
                                <button class="model-control-button" data-action="move-up">↑</button>
                                <div></div>
                                <button class="model-control-button" data-action="move-left">←</button>
                                <button class="model-control-button" data-action="move-down">↓</button>
                                <button class="model-control-button" data-action="move-right">→</button>
                            </div>
                            <div class="grid grid-cols-2 gap-1">
                                <button class="model-control-button toggle-lock" data-action="toggle-lock">Lock Cam</button>
                                <button class="model-control-button" data-action="reset-view">Reset</button>
                                <button class="model-control-button" data-action="toggle-rotation">Auto-Rotate</button>
                                <button class="model-control-button" data-action="toggle-background">Toggle BG</button>
                                <button class="model-control-button" data-action="toggle-wireframe">Wireframe</button>
                                <button class="model-control-button" data-action="screenshot">Screenshot</button>
                                <button class="model-control-button" data-action="scale-up">Scale +</button>
                                <button class="model-control-button" data-action="scale-down">Scale -</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="lg:w-1/2 text-left">
                    <p class="text-xl leading-relaxed mb-6 text-gray-300">
                        <span class="text-neon-blue">Avneed</span> is more than just a digital assistant; it's a meticulously engineered companion designed to seamlessly integrate with your unique working style and preferences. Our paramount objective is to furnish immediate, contextually relevant information and assistance for your personal projects, regardless of their complexity or scale.
                    </p>
                    <p class="text-xl leading-relaxed text-gray-300">
                        What truly sets <span class="text-neon-blue">Avneed</span> apart is its unique capability to operate autonomously even without internet connectivity. This ensures you're never left without the assistance you require, making it an invaluable ally for creative endeavors or critical research in remote locations.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section id="capabilities" class="py-20 px-6 bg-[#121212] shadow-inner">
        <div class="container mx-auto text-center">
            <h3 id="capabilitiesTitle" class="text-5xl font-bold mb-16 text-gray-100 leading-tight">Unleash Your Potential with <span class="text-neon-blue">Avneed</span>'s Core Capabilities</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                <div class="card">
                    <h4 id="persistentPresence" class="text-3xl font-bold mb-4 text-yellow-400">Persistent Desktop Presence</h4>
                    <p class="text-gray-300 leading-relaxed">
                        Imagine a floating, interactive 3D animated model that seamlessly integrates into your desktop, always visible and on top of other applications, transforming your workspace into a personalized hub.
                    </p>
                </div>
                <div class="card">
                    <h4 id="dynamicInteraction" class="text-3xl font-bold mb-4 text-yellow-400">Dynamic Interaction</h4>
                    <p class="text-gray-300 leading-relaxed">
                        Engage with the 3D model to unveil a comprehensive interactive interface, complete with informative pop-ups and captivating animations that enrich your experience and foster deeper understanding.
                    </p>
                </div>
                <div class="card">
                    <h4 id="multiModalInput" class="text-3xl font-bold mb-4 text-yellow-400">Multi-Modal Input</h4>
                    <p class="text-gray-300 leading-relaxed">
                        Interact effortlessly with <span class="text-neon-blue">Avneed</span> using conventional text-based inquiries, direct file uploads (Word, PDF, text), and intuitive voice commands via your device's microphone.
                    </p>
                </div>
                <div class="card">
                    <h4 id="contextualAssistance" class="text-3xl font-bold mb-4 text-yellow-400">Contextual Assistance</h4>
                    <p class="text-gray-300 leading-relaxed">
                        Harnesses your uploaded documents to cite specific details, condense content, extract essential concepts, and provide meticulous assistance with reports, books, or research endeavors.
                    </p>
                </div>
                <div class="card">
                    <h4 id="crossDeviceFunctionality" class="text-3xl font-bold mb-4 text-yellow-400">Cross-Device Functionality</h4>
                    <p class="text-gray-300 leading-relaxed">
                        Ingeniously engineered for seamless integration across laptops, desktops, and smartphones, ensuring you can access your work and <span class="text-neon-blue">Avneed</span>'s support whenever and wherever you choose.
                    </p>
                </div>
                <div class="card">
                    <h4 id="offlineCapability" class="text-3xl font-bold mb-4 text-yellow-400">Offline Capability</h4>
                    <p class="text-gray-300 leading-relaxed">
                        The essential functionalities of <span class="text-neon-blue">Avneed</span> are meticulously designed to operate effectively without an active internet connection, particularly for processing local files, ensuring uninterrupted productivity.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- New AI Features Section with bubble buttons -->
    <section id="ai-features" class="py-20 px-6 bg-[#1a1a2e] shadow-inner text-center">
        <div class="container mx-auto">
            <h3 class="text-5xl font-bold mb-16 text-gray-100 leading-tight">Explore Avneed's AI Capabilities</h3>
            <div class="flex flex-col md:flex-row justify-center gap-8">
                <button id="openChatbotBtn" class="sphere-button neon-hover">Chat</button>
                <button id="openImageGeneratorBtn" class="sphere-button neon-hover">Image</button>
                <button id="openVideoGeneratorBtn" class="sphere-button neon-hover">Video</button>
            </div>
        </div>
    </section>

    <section id="contact" class="py-20 px-6 gradient-bg text-white text-center shadow-inner">
        <div class="container mx-auto">
            <h3 id="contactTitle" class="text-5xl font-bold mb-8 drop-shadow-lg">Ready to Transform Your Workflow?</h3>
            <p id="contactSubheading" class="text-2xl mb-12 max-w-3xl mx-auto opacity-90">
                Join the future of personal AI assistance. Sign up for early access and stay tuned for <span class="text-neon-blue">Avneed</span>'s groundbreaking release!
            </p>
            <div class="contact-content-wrapper">
                <form class="contact-form-container max-w-lg mx-auto bg-gray-900 p-10 rounded-3xl shadow-2xl border border-gray-700">
                    <h4 id="getUpdatesTitle" class="text-3xl font-bold mb-8 text-gray-100">Get Early Access Updates</h4>
                    <div class="flex flex-col md:flex-row gap-6 mb-6">
                        <input type="text" id="yourNameInput" placeholder="Your Name" class="flex-1 input-field min-w-0">
                        <input type="email" id="yourEmailInput" placeholder="Your Email" class="flex-1 input-w-0">
                    </div>
                    <button type="submit" id="signUpBtn" class="btn-primary w-full">Sign Up for Updates</button>
                </form>

                <div class="new-model-viewer-area max-w-lg mx-auto">
                    <div id="secondaryModelContainer" class="model-viewer-container">
                        <canvas id="secondaryModelCanvas" class="model-viewer-canvas"></canvas>
                        <div id="secondaryModelStatus" class="model-status hidden">
                            <div class="loading-spinner mb-4"></div>
                            <p>Loading 3D Model...</p>
                        </div>
                        <label for="secondaryModelFileInput" id="secondaryModelFileInputLabel" class="model-file-input-label">+</label>
                        <input type="file" id="secondaryModelFileInput" accept=".gltf, .glb" class="hidden-file-input">
                        <input type="file" id="secondaryAudioFileInput" accept=".mp3" class="hidden-file-input">

                        <div id="secondaryUploadMenu" class="upload-menu hidden">
                            <button class="upload-menu-button" data-type="model">Upload 3D Model</button>
                            <button class="upload-menu-button" data-type="audio">Upload MP3</button>
                        </div>

                        <div id="secondaryAudioControls" class="audio-controls hidden">
                            <button class="audio-play-pause-button" data-action="play-pause">▶</button>
                        </div>
                        <audio id="secondaryAudioPlayer" class="hidden"></audio>

                        <div id="secondaryResizeHandle" class="resize-handle"></div>
                        <div id="secondaryModelControls" class="model-controls hidden">
                            <div class="grid grid-cols-3 gap-1">
                                <div></div>
                                <button class="model-control-button" data-action="move-up">↑</button>
                                <div></div>
                                <button class="model-control-button" data-action="move-left">←</button>
                                <button class="model-control-button" data-action="move-down">↓</button>
                                <button class="model-control-button" data-action="move-right">→</button>
                            </div>
                            <div class="grid grid-cols-2 gap-1">
                                <button class="model-control-button toggle-lock" data-action="toggle-lock">Lock Cam</button>
                                <button class="model-control-button" data-action="reset-view">Reset</button>
                                <button class="model-control-button" data-action="toggle-rotation">Auto-Rotate</button>
                                <button class="model-control-button" data-action="toggle-background">Toggle BG</button>
                                <button class="model-control-button" data-action="toggle-wireframe">Wireframe</button>
                                <button class="model-control-button" data-action="screenshot">Screenshot</button>
                                <button class="model-control-button" data-action="scale-up">Scale +</button>
                                <button class="model-control-button" data-action="scale-down">Scale -</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- New bubble buttons for Notes and Login -->
            <div class="contact-buttons-wrapper">
                <button id="openNotesBtn" class="sphere-button neon-hover">Notes</button>
                <button id="openLoginMenuBtn" class="sphere-button neon-hover">Login</button>
            </div>
        </div>
    </section>

    <footer class="bg-gray-950 text-white py-10 px-6">
        <div class="container mx-auto text-center text-gray-500">
            <p class="text-lg" id="copyrightText">&copy; 2025 <span class="text-neon-blue">Avneed</span>. All rights reserved.</p>
            <p class="mt-4 text-md" id="designMessage">Designed with precision for an enhanced user experience and a smarter future.</p>
        </div>
    </footer>

    <!-- Modal Overlay and Content -->
    <div id="aiModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" id="closeModalBtn">&times;</button>
            <div id="modalContentArea">
                <!-- AI feature content will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- AI Feature Content (hidden by default, moved into modal) -->
    <div id="ai-chatbot-content" class="ai-feature-content hidden">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6 text-gray-100 leading-tight">Chatbot</h2>
            <div class="max-w-4xl mx-auto bg-gray-900 p-6 rounded-2xl shadow-xl border border-gray-700">
                <p id="chatInstructions" class="text-sm text-gray-300 mb-4">
                    Chat or upload a file (.txt, .doc, .pdf).
                    <br><span class="text-xs text-gray-400">(Plain text only from files.)</span>
                </p>
                <div id="chatHistory" class="bg-[#1a1a1a] p-4 rounded-xl shadow-md text-left text-gray-200 min-h-[200px] max-h-[300px] overflow-y-auto mb-4 border border-gray-700">
                    <p class="text-gray-400" id="initialChatMessage">Hello! How can I assist?</p>
                </div>
                
                <div class="flex gap-2 mb-2">
                    <textarea id="aiInputText" class="flex-grow input-field resize-none" placeholder="Type message..."></textarea>
                    <label for="aiFileInput" id="aiFileInputLabel" class="ai-button flex-shrink-0 flex items-center justify-center">Upload</label>
                    <input type="file" id="aiFileInput" accept=".txt, .doc, .docx, .pdf" class="hidden-file-input">
                    <button id="sendBtn" class="ai-button flex-shrink-0">Send</button>
                </div>

                <div id="loadingIndicator" class="mt-2 text-center hidden">
                    <div class="loading-spinner"></div>
                    <p class="ml-1 text-gray-300 inline-block text-xs">Thinking...</p>
                </div>
                <div id="errorMessage" class="mt-2 text-center text-red-500 hidden text-xs">
                    <p id="errorMessageText">Error. Try again.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="image-generator-content" class="ai-feature-content hidden">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6 text-gray-100 leading-tight">Image</h2>
            <div class="max-w-4xl mx-auto bg-gray-900 p-6 rounded-2xl shadow-xl border border-gray-700">
                <p id="imageGeneratorInstructions" class="text-sm text-gray-300 mb-4">
                    Describe image. Choose aspect ratio.
                </p>
                
                <div class="flex flex-col gap-4 mb-6">
                    <textarea id="imagePromptInput" class="flex-grow input-field resize-none" placeholder="e.g., 'Futuristic city, sunset, flying cars, cyberpunk'"></textarea>
                    
                    <div class="flex flex-wrap justify-center gap-2 mb-4" id="aspectRatioButtons">
                        <button class="ai-button text-xs px-4 py-2" data-aspect="1-1">1:1</button>
                        <button class="ai-button text-xs px-4 py-2" data-aspect="16-9">16:9</button>
                        <button class="ai-button text-xs px-4 py-2" data-aspect="4-3">4:3</button>
                        <button class="ai-button text-xs px-4 py-2" data-aspect="9-16">9:16</button>
                    </div>

                    <button id="generateImageBtn" class="ai-button">Generate</button>
                </div>

                <div id="imageOutputArea" class="mt-4 flex justify-center items-center relative min-h-[250px]">
                    <div id="imageFrame" class="image-frame-container aspect-1-1">
                        <img id="generatedImage" class="generated-image" src="https://placehold.co/300x300/333333/FFFFFF?text=Image+Here" alt="Generated Image Placeholder">
                        <div id="imageLoadingOverlay" class="image-loading-overlay hidden">
                            <span class="image-loading-spinner"></span>
                            <p id="imageLoadingText">Generating...</p>
                        </div>
                    </div>
                </div>

                <div id="imageErrorMessage" class="mt-2 text-center text-red-500 hidden text-xs">
                    <p id="imageErrorMessageText">Error. Try again.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="video-generator-content" class="ai-feature-content hidden">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6 text-gray-100 leading-tight">Video</h2>
            <div class="max-w-4xl mx-auto bg-gray-900 p-6 rounded-2xl shadow-xl border border-gray-700">
                <p id="videoGeneratorInstructions" class="text-sm text-gray-300 mb-4">
                    Describe video.
                    <br><span class="text-xs text-gray-400">(Demo placeholder.)</span>
                </p>
                
                <div class="flex flex-col gap-4 mb-6">
                    <textarea id="videoPromptInput" class="flex-grow input-field resize-none" placeholder="e.g., 'Robot walking, neon city'"></textarea>
                    
                    <button id="generateVideoBtn" class="ai-button">Generate</button>
                </div>

                <div id="videoOutputArea" class="mt-4 flex justify-center items-center relative min-h-[250px]">
                    <div id="videoPlayerFrame" class="video-player-container aspect-16-9">
                        <video id="generatedVideo" class="generated-video" controls poster="https://placehold.co/480x270/333333/FFFFFF?text=Video+Here">
                            <source src="" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <div id="videoLoadingOverlay" class="video-loading-overlay hidden">
                            <span class="video-loading-spinner"></span>
                            <p id="videoLoadingText">Generating...</p>
                        </div>
                    </div>
                </div>

                <div id="videoErrorMessage" class="mt-2 text-center text-red-500 hidden text-xs">
                    <p id="videoErrorMessageText">Error. Try again.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Notes Content (hidden by default, moved into modal) -->
    <div id="user-notes-content" class="ai-feature-content hidden">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6 text-gray-100 leading-tight">Your Private Notes 📝</h2>
            <div class="max-w-4xl mx-auto bg-gray-900 p-6 rounded-2xl shadow-xl border border-gray-700">
                <p class="text-sm text-gray-300 mb-4">
                    Log in with GitHub to save and load your personal notes. These notes are private to your account.
                </p>
                <div class="flex flex-col gap-4 mb-6">
                    <textarea id="userNotesInput" class="flex-grow input-field resize-none" placeholder="Type your private notes here..." disabled></textarea>
                    <button id="saveNotesBtn" class="ai-button" disabled>Save Notes</button>
                </div>
                <p id="userNotesStatus" class="mt-2 text-center text-gray-400 text-xs">Please log in to save notes.</p>
            </div>
        </div>
    </div>

    <!-- Login Menu Content (hidden by default, moved into modal) -->
    <div id="login-menu-content" class="ai-feature-content hidden">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6 text-gray-100 leading-tight">Account</h2>
            <div class="max-w-4xl mx-auto bg-gray-900 p-6 rounded-2xl shadow-xl border border-gray-700">
                <p class="text-sm text-gray-300 mb-4">
                    Manage your Avneed account.
                </p>
                <div class="flex flex-col gap-4 mb-6">
                    <button id="loginBtnModalGoogle" class="ai-button">Log In with Google</button>
                    <button id="loginBtnModalGithub" class="ai-button">Log In with GitHub</button>
                    <button id="loginBtnModalGuest" class="ai-button">Continue as Guest</button>
                    <button id="logoutBtnModal" class="ai-button hidden">Log Out</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        const aiModal = document.getElementById('aiModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalContentArea = document.getElementById('modalContentArea');

        const openChatbotBtn = document.getElementById('openChatbotBtn');
        const openImageGeneratorBtn = document.getElementById('openImageGeneratorBtn');
        const openVideoGeneratorBtn = document.getElementById('openVideoGeneratorBtn');
        const openNotesBtn = document.getElementById('openNotesBtn'); // New Notes button
        const openLoginMenuBtn = document.getElementById('openLoginMenuBtn'); // New Login button

        const aiChatbotContent = document.getElementById('ai-chatbot-content');
        const imageGeneratorContent = document.getElementById('image-generator-content');
        const videoGeneratorContent = document.getElementById('video-generator-content');
        const userNotesContent = document.getElementById('user-notes-content'); // New Notes content div
        const loginMenuContent = document.getElementById('login-menu-content'); // New Login content div

        // References to elements within the modal content (will be dynamically attached)
        let aiInputText, aiFileInput, sendBtn, chatHistoryDiv, loadingIndicator, errorMessage;
        let imagePromptInput, aspectRatioButtons, generateImageBtn, imageFrame, generatedImage, imageLoadingOverlay, imageLoadingText, imageErrorMessage;
        let videoPromptInput, generateVideoBtn, videoPlayerFrame, generatedVideo, videoLoadingOverlay, videoLoadingText, videoErrorMessage;
        let userNotesInput, saveNotesBtn, userNotesStatus; // Notes modal elements
        let loginBtnModalGoogle, loginBtnModalGithub, loginBtnModalGuest, logoutBtnModal; // Login modal elements

        let chatHistory = [{ role: "model", parts: [{ text: "Hello! How can I assist?" }] }];
        let selectedAspectRatio = '1-1';

        const settingsBtn = document.getElementById('settingsBtn');
        const settingsMenu = document.getElementById('settingsMenu');

        const modelContainer = document.getElementById('modelContainer');
        const modelCanvas = document.getElementById('modelCanvas');
        const modelFileInput = document.getElementById('modelFileInput');
        const audioFileInput = document.getElementById('audioFileInput');
        const modelStatus = document.getElementById('modelStatus');
        const resizeHandle = document.getElementById('resizeHandle');
        const modelControls = document.getElementById('modelControls');
        const modelFileInputLabel = document.getElementById('modelFileInputLabel');
        const uploadMenu = document.getElementById('uploadMenu');
        const audioControls = document.getElementById('audioControls');
        const primaryAudioPlayer = document.getElementById('primaryAudioPlayer');

        const secondaryModelContainer = document.getElementById('secondaryModelContainer');
        const secondaryModelCanvas = document.getElementById('secondaryModelCanvas');
        const secondaryModelFileInput = document.getElementById('secondaryModelFileInput');
        const secondaryAudioFileInput = document.getElementById('secondaryAudioFileInput');
        const secondaryModelStatus = document.getElementById('secondaryModelStatus');
        const secondaryResizeHandle = document.getElementById('secondaryResizeHandle');
        const secondaryModelControls = document.getElementById('secondaryModelControls');
        const secondaryModelFileInputLabel = document.getElementById('secondaryModelFileInputLabel');
        const secondaryUploadMenu = document.getElementById('secondaryUploadMenu');
        const secondaryAudioControls = document.getElementById('secondaryAudioControls');
        const secondaryAudioPlayer = document.getElementById('secondaryAudioPlayer');

        const discoverAvneedBtn = document.getElementById('discoverAvneedBtn');
        const mainAudioPlayer = document.getElementById('mainHeroAudio');
        const mainAudioPlayerContainer = document.getElementById('mainAudioPlayerContainer');
        const mainAudioPlayToggle = document.getElementById('mainAudioPlayToggle');
        const heroHeading = document.getElementById('heroHeading');
        const heroSubheading = document.getElementById('heroSubheading');

        let currentLanguage = localStorage.getItem('language') || 'en';
        let currentTheme = localStorage.getItem('theme') || 'dark';

        // Store original parent of each section for re-attachment
        const originalParents = new Map();
        originalParents.set('ai-chatbot-content', aiChatbotContent.parentNode);
        originalParents.set('image-generator-content', imageGeneratorContent.parentNode);
        originalParents.set('video-generator-content', videoGeneratorContent.parentNode);
        originalParents.set('user-notes-content', userNotesContent.parentNode); // Store original parent for notes
        originalParents.set('login-menu-content', loginMenuContent.parentNode); // Store original parent for login

        const translations = {
            en: {
                heroHeading: 'Empower Your Workflow with <span class="text-neon-blue">Avneed</span>',
                heroSubheading: 'The proactive, omnipresent AI assistant designed to seamlessly integrate with your digital life, providing intelligent support across all your devices.',
                discoverAvneed: 'Discover <span class="text-neon-blue">Avneed</span>',
                visionTitle: 'Our Vision: A Transformative Companion',
                capabilitiesTitle: 'Unleash Your Potential with <span class="text-neon-blue">Avneed</span>\'s Core Capabilities',
                persistentPresence: 'Persistent Desktop Presence',
                dynamicInteraction: 'Dynamic Interaction',
                multiModalInput: 'Multi-Modal Input',
                contextualAssistance: 'Contextual Assistance',
                crossDeviceFunctionality: 'Cross-Device Functionality',
                offlineCapability: 'Offline Capability',
                exploreAICapabilities: 'Explore Avneed\'s AI Capabilities',
                contactTitle: 'Ready to Transform Your Workflow?',
                contactSubheading: 'Join the future of personal AI assistance. Sign up for early access and stay tuned for <span class="text-neon-blue">Avneed</span>\'s groundbreaking release!',
                getUpdates: 'Get Early Access Updates',
                yourName: 'Your Name',
                yourEmail: 'Your Email',
                signUp: 'Sign Up for Updates',
                copyright: '&copy; 2025 <span class="text-neon-blue">Avneed</span>. All rights reserved.',
                designMessage: 'Designed with precision for an enhanced user experience and a smarter future.',
                language: 'Language',
                firebaseNotInit: 'Firebase not initialized.',

                // Modal specific translations (minimalist)
                chatbotTitle: 'Chatbot',
                chatInstructions: 'Chat or upload a file (.txt, .doc, .pdf).<br><span class="text-xs text-gray-400">(Plain text only from files.)</span>',
                initialChatMessage: 'Hello! How can I assist?',
                typeMessage: 'Type message...',
                uploadFile: 'Upload',
                send: 'Send',
                avneedThinking: 'Thinking...',
                errorOccurred: 'Error. Try again.',
                errorReadingFile: 'Error reading file.',
                imageTitle: 'Image',
                imageGeneratorInstructions: 'Describe image. Choose aspect ratio.',
                square: '1:1',
                landscape: '16:9',
                standard: '4:3',
                portrait: '9:16',
                generateImage: 'Generate',
                generatingImage: 'Generating...',
                imageGenError: 'Error. Try again.',
                imageGenFailed: 'Image generation failed.',
                videoTitle: 'Video',
                videoGeneratorInstructions: 'Describe video.<br><span class="text-xs text-gray-400">(Demo placeholder.)</span>',
                generateVideo: 'Generate',
                generatingVideo: 'Generating...',
                videoGenError: 'Error. Try again.',
                robotWalkingNeonCity: 'Robot walking, neon city', // Example placeholder
                
                // New translations for Notes and Login modals
                notesTitle: 'Your Private Notes 📝',
                notesLoginPrompt: 'Log in with GitHub to save and load your personal notes. These notes are private to your account.',
                typeNotesPlaceholder: 'Type your private notes here...',
                saveNotes: 'Save Notes',
                notesLoginStatus: 'Please log in to save notes.',
                notesSavedSuccess: 'Notes saved successfully!',
                notesSaveError: 'Error saving notes:',
                notesLoaded: 'Notes loaded.',
                noNotesFound: 'No notes found. Start typing!',
                notesLoadError: 'Error loading notes:',

                loginMenuTitle: 'Account',
                manageAccount: 'Manage your Avneed account.',
                loginWithGoogle: 'Log In with Google',
                loginWithGitHub: 'Log In with GitHub',
                continueAsGuest: 'Continue as Guest',
                logout: 'Log Out',
            }
        };

        function applyTheme(theme) {
            document.body.classList.remove('dark-theme', 'light-theme');
            document.body.classList.add(theme + '-theme');
            currentTheme = theme;
            localStorage.setItem('theme', theme);
        }

        function applyLanguage(lang) {
            const currentTranslations = translations[lang];
            if (!currentTranslations) return;

            heroHeading.innerHTML = currentTranslations.heroHeading;
            heroSubheading.innerHTML = currentTranslations.heroSubheading;
            discoverAvneedBtn.innerHTML = currentTranslations.discoverAvneed;
            document.getElementById('visionTitle').textContent = currentTranslations.visionTitle;
            document.getElementById('capabilitiesTitle').innerHTML = currentTranslations.capabilitiesTitle;
            document.getElementById('persistentPresence').textContent = currentTranslations.persistentPresence;
            document.getElementById('dynamicInteraction').textContent = currentTranslations.dynamicInteraction;
            document.getElementById('multiModalInput').textContent = currentTranslations.multiModalInput;
            document.getElementById('contextualAssistance').textContent = currentTranslations.contextualAssistance;
            document.getElementById('crossDeviceFunctionality').textContent = currentTranslations.crossDeviceFunctionality;
            document.getElementById('offlineCapability').textContent = currentTranslations.offlineCapability;
            document.querySelector('#ai-features h3').textContent = currentTranslations.exploreAICapabilities;
            document.getElementById('contactTitle').textContent = currentTranslations.contactTitle;
            document.getElementById('contactSubheading').innerHTML = currentTranslations.contactSubheading;
            document.getElementById('getUpdatesTitle').textContent = currentTranslations.getUpdates;
            document.getElementById('yourNameInput').placeholder = currentTranslations.yourName;
            document.getElementById('yourEmailInput').placeholder = currentTranslations.yourEmail;
            document.getElementById('signUpBtn').textContent = currentTranslations.signUp;
            document.getElementById('copyrightText').innerHTML = currentTranslations.copyright;
            document.getElementById('designMessage').textContent = currentTranslations.designMessage;
            document.getElementById('languageSettingLabel').textContent = currentTranslations.language;
            
            // Apply translations to modal content if it's currently in the DOM
            if (modalContentArea.contains(aiChatbotContent)) {
                aiChatbotContent.querySelector('h2').textContent = currentTranslations.chatbotTitle;
                aiChatbotContent.querySelector('#chatInstructions').innerHTML = currentTranslations.chatInstructions;
                aiChatbotContent.querySelector('#initialChatMessage').textContent = currentTranslations.initialChatMessage;
                aiChatbotContent.querySelector('#aiInputText').placeholder = currentTranslations.typeMessage;
                aiChatbotContent.querySelector('#aiFileInputLabel').textContent = currentTranslations.uploadFile;
                aiChatbotContent.querySelector('#sendBtn').textContent = currentTranslations.send;
                aiChatbotContent.querySelector('#loadingIndicator p').textContent = currentTranslations.avneedThinking;
                aiChatbotContent.querySelector('#errorMessageText').textContent = currentTranslations.errorOccurred;
            }
            if (modalContentArea.contains(imageGeneratorContent)) {
                imageGeneratorContent.querySelector('h2').textContent = currentTranslations.imageTitle;
                imageGeneratorContent.querySelector('#imageGeneratorInstructions').textContent = currentTranslations.imageGeneratorInstructions;
                imageGeneratorContent.querySelector('#aspectRatioButtons button[data-aspect="1-1"]').textContent = currentTranslations.square;
                imageGeneratorContent.querySelector('#aspectRatioButtons button[data-aspect="16-9"]').textContent = currentTranslations.landscape;
                imageGeneratorContent.querySelector('#aspectRatioButtons button[data-aspect="4-3"]').textContent = currentTranslations.standard;
                imageGeneratorContent.querySelector('#aspectRatioButtons button[data-aspect="9-16"]').textContent = currentTranslations.portrait;
                imageGeneratorContent.querySelector('#generateImageBtn').textContent = currentTranslations.generateImage;
                imageGeneratorContent.querySelector('#imageLoadingText').textContent = currentTranslations.generatingImage;
                imageGeneratorContent.querySelector('#imageErrorMessageText').textContent = currentTranslations.imageGenError;
                imageGeneratorContent.querySelector('#imagePromptInput').placeholder = `e.g., 'Futuristic city, sunset, flying cars, cyberpunk'`; // Keep example specific
            }
            if (modalContentArea.contains(videoGeneratorContent)) {
                videoGeneratorContent.querySelector('h2').textContent = currentTranslations.videoTitle;
                videoGeneratorContent.querySelector('#videoGeneratorInstructions').innerHTML = currentTranslations.videoGeneratorInstructions;
                videoGeneratorContent.querySelector('#generateVideoBtn').textContent = currentTranslations.generateVideo;
                videoGeneratorContent.querySelector('#videoLoadingText').textContent = currentTranslations.generatingVideo;
                videoGeneratorContent.querySelector('#videoErrorMessage p').textContent = currentTranslations.videoGenError;
                videoGeneratorContent.querySelector('#videoPromptInput').placeholder = `e.g., '${currentTranslations.robotWalkingNeonCity}'`;
            }
            if (modalContentArea.contains(userNotesContent)) {
                userNotesContent.querySelector('h2').textContent = currentTranslations.notesTitle;
                userNotesContent.querySelector('.text-sm.text-gray-300').innerHTML = currentTranslations.notesLoginPrompt;
                userNotesContent.querySelector('#userNotesInput').placeholder = currentTranslations.typeNotesPlaceholder;
                userNotesContent.querySelector('#saveNotesBtn').textContent = currentTranslations.saveNotes;
                userNotesContent.querySelector('#userNotesStatus').textContent = currentTranslations.notesLoginStatus;
            }
            if (modalContentArea.contains(loginMenuContent)) {
                loginMenuContent.querySelector('h2').textContent = currentTranslations.loginMenuTitle;
                loginMenuContent.querySelector('.text-sm.text-gray-300').textContent = currentTranslations.manageAccount;
                loginMenuContent.querySelector('#loginBtnModalGoogle').textContent = currentTranslations.loginWithGoogle;
                loginMenuContent.querySelector('#loginBtnModalGithub').textContent = currentTranslations.loginWithGitHub;
                loginMenuContent.querySelector('#loginBtnModalGuest').textContent = currentTranslations.continueAsGuest;
                loginMenuContent.querySelector('#logoutBtnModal').textContent = currentTranslations.logout;
            }

            currentLanguage = lang;
            localStorage.setItem('language', lang);
        }

        applyTheme(currentTheme);
        applyLanguage(currentLanguage);

        settingsBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            settingsMenu.classList.toggle('hidden');
        });

        settingsMenu.querySelectorAll('.settings-menu-button').forEach(button => {
            button.addEventListener('click', (event) => {
                if (event.target.dataset.theme) {
                    const theme = event.target.dataset.theme;
                    applyTheme(theme);
                } else if (event.target.dataset.lang) {
                    const lang = event.target.dataset.lang;
                    applyLanguage(lang);
                }
                settingsMenu.classList.add('hidden');
            });
        });

        document.addEventListener('click', (event) => {
            if (!settingsMenu.contains(event.target) && event.target !== settingsBtn) {
                settingsMenu.classList.add('hidden');
            }
        });

        function displayMessage(role, text) {
            const chatHistoryDiv = modalContentArea.querySelector('#chatHistory');
            if (!chatHistoryDiv) return; // Ensure chat history div exists in modal

            const messageElement = document.createElement('p');
            messageElement.classList.add('mb-2', 'p-3', 'rounded-lg', 'max-w-[75%]');
            
            if (role === 'user') {
                messageElement.classList.add('user-message');
            } else {
                messageElement.classList.add('ai-message');
            }
            messageElement.textContent = text;
            chatHistoryDiv.appendChild(messageElement);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        async function sendChatMessage() {
            const aiInputText = modalContentArea.querySelector('#aiInputText');
            const loadingIndicator = modalContentArea.querySelector('#loadingIndicator');
            const errorMessage = modalContentArea.querySelector('#errorMessage');
            const sendBtn = modalContentArea.querySelector('#sendBtn');

            if (!aiInputText || !loadingIndicator || !errorMessage || !sendBtn) return;

            const userMessage = aiInputText.value.trim();
            if (!userMessage) return;

            displayMessage('user', userMessage);
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            aiInputText.value = '';

            aiInputText.style.height = 'auto';

            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            sendBtn.disabled = true; // Disable send button during processing

            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    displayMessage('model', aiResponse);
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                } else {
                    displayMessage('model', translations[currentLanguage].errorOccurred);
                }
            } catch (error) {
                errorMessage.classList.remove('hidden');
                errorMessage.querySelector('p').textContent = translations[currentLanguage].errorOccurred + ` (${error.message})`;
                console.error("Chatbot API error:", error);
            } finally {
                loadingIndicator.classList.add('hidden');
                sendBtn.disabled = false; // Re-enable send button
            }
        }

        function setupChatbotListeners() {
            aiInputText = modalContentArea.querySelector('#aiInputText');
            aiFileInput = modalContentArea.querySelector('#aiFileInput');
            sendBtn = modalContentArea.querySelector('#sendBtn');
            chatHistoryDiv = modalContentArea.querySelector('#chatHistory');
            loadingIndicator = modalContentArea.querySelector('#loadingIndicator');
            errorMessage = modalContentArea.querySelector('#errorMessage');

            if (sendBtn) sendBtn.addEventListener('click', sendChatMessage);
            if (aiInputText) {
                aiInputText.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        sendChatMessage();
                    }
                });
                aiInputText.addEventListener('input', () => {
                    aiInputText.style.height = 'auto';
                    aiInputText.style.height = (aiInputText.scrollHeight) + 'px';
                    if (aiInputText.scrollHeight > aiInputText.clientHeight) {
                        aiInputText.style.overflowY = 'auto';
                    } else {
                        aiInputText.style.overflowY = 'hidden';
                    }
                });
            }
            if (aiFileInput) {
                aiFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const fileContent = e.target.result;
                            aiInputText.value = `File content:\n\n${fileContent}\n\nMy question: `;
                            aiInputText.focus();
                            aiInputText.dispatchEvent(new Event('input'));
                        };
                        reader.onerror = () => {
                            errorMessage.classList.remove('hidden');
                            errorMessage.textContent = translations[currentLanguage].errorReadingFile;
                        };
                        reader.readAsText(file);
                    }
                });
            }
        }

        async function generateImage() {
            const prompt = imagePromptInput.value.trim();
            if (!prompt) {
                imageErrorMessage.classList.remove('hidden');
                imageErrorMessage.querySelector('p').textContent = translations[currentLanguage].imageGenError;
                return;
            }

            imageLoadingOverlay.classList.remove('hidden');
            generatedImage.style.opacity = '0.5';
            imageErrorMessage.classList.add('hidden');
            
            generateImageBtn.classList.add('selected-button');
            generateImageBtn.disabled = true;
            generateImageBtn.innerHTML = `<span class="loading-spinner w-5 h-5 mr-2"></span> ${translations[currentLanguage].generatingImage}`;

            const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1} };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    generatedImage.src = imageUrl;
                    generatedImage.alt = prompt;
                    generatedImage.style.opacity = '1';
                } else {
                    imageErrorMessage.classList.remove('hidden');
                    imageErrorMessage.querySelector('p').textContent = translations[currentLanguage].imageGenFailed;
                }
            } catch (error) {
                console.error("Error generating image:", error);
                imageErrorMessage.classList.remove('hidden');
                imageErrorMessage.querySelector('p').textContent = `${translations[currentLanguage].imageGenError} (${error.message}).`;
            } finally {
                imageLoadingOverlay.classList.add('hidden');
                generateImageBtn.classList.remove('selected-button');
                generateImageBtn.disabled = false;
                generateImageBtn.textContent = translations[currentLanguage].generateImage;
            }
        }

        function setupImageGeneratorListeners() {
            imagePromptInput = modalContentArea.querySelector('#imagePromptInput');
            aspectRatioButtons = modalContentArea.querySelector('#aspectRatioButtons');
            generateImageBtn = modalContentArea.querySelector('#generateImageBtn');
            imageFrame = modalContentArea.querySelector('#imageFrame');
            generatedImage = modalContentArea.querySelector('#generatedImage');
            imageLoadingOverlay = modalContentArea.querySelector('#imageLoadingOverlay');
            imageLoadingText = modalContentArea.querySelector('#imageLoadingText');
            imageErrorMessage = modalContentArea.querySelector('#imageErrorMessage');

            if (generateImageBtn) generateImageBtn.addEventListener('click', generateImage);
            if (imagePromptInput) {
                imagePromptInput.addEventListener('input', () => {
                    imagePromptInput.style.height = 'auto';
                    imagePromptInput.style.height = (imagePromptInput.scrollHeight) + 'px';
                    if (imagePromptInput.scrollHeight > imagePromptInput.clientHeight) {
                        imagePromptInput.style.overflowY = 'auto';
                    } else {
                        imagePromptInput.style.overflowY = 'hidden';
                    }
                });
            }
            if (aspectRatioButtons) {
                aspectRatioButtons.addEventListener('click', (event) => {
                    if (event.target.tagName === 'BUTTON') {
                        aspectRatioButtons.querySelectorAll('button').forEach(btn => {
                            btn.classList.remove('selected-button');
                        });
                        event.target.classList.add('selected-button');
                        selectedAspectRatio = event.target.dataset.aspect;
                        imageFrame.classList.remove('aspect-1-1', 'aspect-16-9', 'aspect-4-3', 'aspect-9-16');
                        imageFrame.classList.add(`aspect-${selectedAspectRatio}`);
                    }
                });
                // Ensure default selection
                const defaultAspectButton = aspectRatioButtons.querySelector('button[data-aspect="1-1"]');
                if (defaultAspectButton) defaultAspectButton.classList.add('selected-button');
            }
        }

        async function generateVideo() {
            const prompt = videoPromptInput.value.trim();
            if (!prompt) {
                videoErrorMessage.classList.remove('hidden');
                videoErrorMessage.querySelector('p').textContent = translations[currentLanguage].videoGenError;
                return;
            }

            videoLoadingOverlay.classList.remove('hidden');
            generatedVideo.style.opacity = '0.5';
            videoErrorMessage.classList.add('hidden');
            
            generateVideoBtn.classList.add('selected-button');
            generateVideoBtn.disabled = true;
            generateVideoBtn.innerHTML = `<span class="loading-spinner w-5 h-5 mr-2"></span> ${translations[currentLanguage].generatingVideo}`;

            try {
                await new Promise(resolve => setTimeout(resolve, 3000)); 
                
                generatedVideo.src = "https://www.w3schools.com/html/mov_bbb.mp4";
                generatedVideo.load(); 
                generatedVideo.play(); 
                generatedVideo.style.opacity = '1';

            } catch (error) {
                console.error("Error generating video (simulated):", error);
                videoErrorMessage.classList.remove('hidden');
                videoErrorMessage.querySelector('p').textContent = translations[currentLanguage].videoGenError;
            } finally {
                videoLoadingOverlay.classList.add('hidden');
                generateVideoBtn.classList.remove('selected-button');
                generateVideoBtn.disabled = false;
                generateVideoBtn.textContent = translations[currentLanguage].generateVideo;
            }
        }

        function setupVideoGeneratorListeners() {
            videoPromptInput = modalContentArea.querySelector('#videoPromptInput');
            generateVideoBtn = modalContentArea.querySelector('#generateVideoBtn');
            videoPlayerFrame = modalContentArea.querySelector('#videoPlayerFrame');
            generatedVideo = modalContentArea.querySelector('#generatedVideo');
            videoLoadingOverlay = modalContentArea.querySelector('#videoLoadingOverlay');
            videoLoadingText = modalContentArea.querySelector('#videoLoadingText');
            videoErrorMessage = modalContentArea.querySelector('#videoErrorMessage');

            if (generateVideoBtn) generateVideoBtn.addEventListener('click', generateVideo);
            if (videoPromptInput) {
                videoPromptInput.addEventListener('input', () => {
                    videoPromptInput.style.height = 'auto';
                    videoPromptInput.style.height = (videoPromptInput.scrollHeight) + 'px';
                    if (videoPromptInput.scrollHeight > videoPromptInput.clientHeight) {
                        videoPromptInput.style.overflowY = 'auto';
                    } else {
                        videoPromptInput.style.overflowY = 'hidden';
                    }
                });
            }
        }

        function setupUserNotesListeners() {
            userNotesInput = modalContentArea.querySelector('#userNotesInput');
            saveNotesBtn = modalContentArea.querySelector('#saveNotesBtn');
            userNotesStatus = modalContentArea.querySelector('#userNotesStatus');

            if (saveNotesBtn) saveNotesBtn.addEventListener('click', window.saveUserNotes);
            if (userNotesInput) {
                userNotesInput.addEventListener('input', () => {
                    userNotesInput.style.height = 'auto';
                    userNotesInput.style.height = (userNotesInput.scrollHeight) + 'px';
                    if (userNotesInput.scrollHeight > userNotesInput.clientHeight) {
                        userNotesInput.style.overflowY = 'auto';
                    } else {
                        userNotesInput.style.overflowY = 'hidden';
                    }
                });
            }
            // Ensure initial state is correct when modal opens
            window.updateLoginButtons(userId !== null, auth.currentUser?.isAnonymous || false);
        }

        function setupLoginMenuListeners() {
            loginBtnModalGoogle = modalContentArea.querySelector('#loginBtnModalGoogle');
            loginBtnModalGithub = modalContentArea.querySelector('#loginBtnModalGithub');
            loginBtnModalGuest = modalContentArea.querySelector('#loginBtnModalGuest');
            logoutBtnModal = modalContentArea.querySelector('#logoutBtnModal');

            if (loginBtnModalGoogle) loginBtnModalGoogle.addEventListener('click', window.loginWithGoogle);
            if (loginBtnModalGithub) loginBtnModalGithub.addEventListener('click', window.loginWithGitHub);
            if (loginBtnModalGuest) loginBtnModalGuest.addEventListener('click', window.signInAsGuest);
            if (logoutBtnModal) logoutBtnModal.addEventListener('click', window.logoutUser);

            // Ensure initial state is correct when modal opens
            window.updateLoginButtons(userId !== null, auth.currentUser?.isAnonymous || false);
        }


        function openModal(contentElement) {
            modalContentArea.innerHTML = '';
            modalContentArea.appendChild(contentElement);
            contentElement.classList.remove('hidden');
            aiModal.classList.add('visible');
            modalContentArea.scrollTop = 0;
            applyLanguage(currentLanguage); // Re-apply translations for modal content

            // Setup listeners specific to the opened content
            if (contentElement.id === 'ai-chatbot-content') {
                setupChatbotListeners();
            } else if (contentElement.id === 'image-generator-content') {
                setupImageGeneratorListeners();
            } else if (contentElement.id === 'video-generator-content') {
                setupVideoGeneratorListeners();
            } else if (contentElement.id === 'user-notes-content') {
                setupUserNotesListeners();
            } else if (contentElement.id === 'login-menu-content') {
                setupLoginMenuListeners();
            }
        }

        function closeModal() {
            aiModal.classList.remove('visible');
            const currentContent = modalContentArea.firstElementChild;
            if (currentContent && originalParents.has(currentContent.id)) {
                originalParents.get(currentContent.id).appendChild(currentContent);
                currentContent.classList.add('hidden');
            }
            modalContentArea.innerHTML = '';
        }

        closeModalBtn.addEventListener('click', closeModal);
        aiModal.addEventListener('click', (event) => {
            if (event.target === aiModal) {
                closeModal();
            }
        });

        openChatbotBtn.addEventListener('click', () => openModal(aiChatbotContent));
        openImageGeneratorBtn.addEventListener('click', () => openModal(imageGeneratorContent));
        openVideoGeneratorBtn.addEventListener('click', () => openModal(videoGeneratorContent));
        openNotesBtn.addEventListener('click', () => openModal(userNotesContent)); // Event listener for Notes bubble
        openLoginMenuBtn.addEventListener('click', () => openModal(loginMenuContent)); // Event listener for Login bubble


        window.onload = function() {
            viewer1Instance = init3DViewer(modelCanvas, modelContainer, modelStatus, primaryAudioPlayer, audioControls);
            modelFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    loadModel(URL.createObjectURL(file), viewer1Instance, modelStatus, modelControls, modelFileInputLabel, audioControls);
                }
            });
            audioFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const audioURL = URL.createObjectURL(file);
                    viewer1Instance.audioPlayer.src = audioURL;
                    viewer1Instance.audioPlayer.play();
                    viewer1Instance.hasAudioLoaded = true;
                }
            });
            setupResizeHandle(resizeHandle, modelContainer, viewer1Instance.camera, viewer1Instance.renderer);
            setupModelControls(modelControls, viewer1Instance, modelContainer, modelFileInputLabel, uploadMenu);

            animate3D(viewer1Instance);

            loadModel('https://imelijah88.github.io/Avneed/friendlyrobot.glb', viewer1Instance, modelStatus, modelControls, modelFileInputLabel, audioControls);


            viewer2Instance = init3DViewer(secondaryModelCanvas, secondaryModelContainer, secondaryModelStatus, secondaryAudioPlayer, secondaryAudioControls);
            secondaryModelFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    loadModel(URL.createObjectURL(file), viewer2Instance, secondaryModelStatus, secondaryModelControls, secondaryModelFileInputLabel, secondaryAudioControls);
                }
            });
            secondaryAudioFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const audioURL = URL.createObjectURL(file);
                    viewer2Instance.audioPlayer.src = audioURL;
                    secondaryAudioPlayer.play();
                    viewer2Instance.hasAudioLoaded = true;
                }
            });
            setupResizeHandle(secondaryResizeHandle, secondaryModelContainer, viewer2Instance.camera, viewer2Instance.renderer);
            setupModelControls(secondaryModelControls, viewer2Instance, secondaryModelContainer, secondaryModelFileInputLabel, secondaryUploadMenu);
            animate3D(viewer2Instance);

            loadModel('https://imelijah88.github.io/Avneed/metalady.glb', viewer2Instance, secondaryModelStatus, secondaryModelControls, secondaryModelFileInputLabel, secondaryAudioControls);
        };

        discoverAvneedBtn.addEventListener('click', () => {
            document.getElementById('vision').scrollIntoView({
                behavior: 'smooth'
            });

            heroHeading.classList.remove('glitch-text');
            void heroHeading.offsetWidth;
            heroHeading.classList.add('glitch-text');

            setTimeout(() => {
                heroHeading.classList.remove('glitch-text');
            }, 1600);

            mainHeroAudio.play().catch(error => {
                console.error("Audio playback failed:", error);
            });

            discoverAvneedBtn.classList.add('hidden');
            mainAudioPlayerContainer.classList.remove('hidden');
            mainAudioPlayToggle.textContent = '⏸';
        });

        mainAudioPlayToggle.addEventListener('click', () => {
            if (mainAudioPlayer.paused) {
                mainAudioPlayer.play();
                mainAudioPlayToggle.textContent = '⏸';
            } else {
                mainAudioPlayer.pause();
                mainAudioPlayToggle.textContent = '▶';
            }
        });

        mainAudioPlayer.addEventListener('ended', () => {
            mainAudioPlayToggle.textContent = '▶';
        });

        function init3DViewer(canvas, container, statusElement, audioPlayerElement, audioControlsElement) {
            const scene = new THREE.Scene();
            scene.background = null;

            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 5);

            const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearAlpha(0);

            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;
            controls.maxPolarAngle = Math.PI / 2;

            const ambientLight = new THREE.AmbientLight(0xffffff, 2.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.8);
            directionalLight.position.set(0, 5, 5).normalize();
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0x00FFFF, 2.0, 100);
            pointLight.position.set(2, 2, 2);
            scene.add(pointLight);

            statusElement.classList.remove('hidden');
            statusElement.innerHTML = '<p>Upload a 3D model (.gltf, .glb)</p><p>Use mouse to interact</p>';

            const playPauseButton = audioControlsElement.querySelector('[data-action="play-pause"]');
            audioPlayerElement.addEventListener('play', () => { playPauseButton.textContent = '⏸'; });
            audioPlayerElement.addEventListener('pause', () => { playPauseButton.textContent = '▶'; });
            audioPlayerElement.addEventListener('ended', () => { playPauseButton.textContent = '▶'; });
            
            playPauseButton.addEventListener('click', () => {
                if (audioPlayerElement.paused) {
                    audioPlayerElement.play();
                } else {
                    audioPlayerElement.pause();
                }
            });

            return { 
                scene, 
                camera, 
                renderer, 
                controls, 
                currentModel: null, 
                mixer: null, 
                clock: new THREE.Clock(), 
                isCameraLocked: false,
                autoRotate: true,
                isBackgroundSolid: false,
                isWireframe: false,
                initialCameraPosition: camera.position.clone(),
                initialControlsTarget: controls.target.clone(),
                initialModelPosition: new THREE.Vector3(),
                initialModelRotation: new THREE.Euler(),
                initialModelScale: new THREE.Vector3(1,1,1),
                audioPlayer: audioPlayerElement, 
                audioControls: audioControlsElement,
                hasAudioLoaded: false, 
            };
        }

        function onWindowResize(camera, renderer, container) {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function animate3D(viewerInstance) {
            requestAnimationFrame(() => animate3D(viewerInstance));

            const delta = viewerInstance.clock.getDelta();

            if (viewerInstance.mixer) {
                viewerInstance.mixer.update(delta);
            }

            if (viewerInstance.currentModel && viewerInstance.autoRotate) {
                viewerInstance.currentModel.rotation.y += 0.015;
            }

            viewerInstance.controls.update();
            viewerInstance.renderer.render(viewerInstance.scene, viewerInstance.camera);
        }

        function loadModel(modelPath, viewerInstance, statusElement, controlsElement, fileInputLabelElement, audioControlsElement) {
            statusElement.classList.remove('hidden');
            statusElement.innerHTML = '<div class="loading-spinner mb-4"></div><p>Loading 3D Model...</p>';
            
            const modelFileInput = fileInputLabelElement.nextElementSibling;

            if (modelFileInput) modelFileInput.style.display = 'none';
            if (fileInputLabelElement) fileInputLabelElement.classList.add('hidden');
            if (controlsElement) controlsElement.classList.add('hidden');
            if (audioControlsElement) audioControlsElement.classList.add('hidden');

            const loader = new THREE.GLTFLoader();
            loader.load(modelPath, (gltf) => {
                if (viewerInstance.currentModel) {
                    viewerInstance.scene.remove(viewerInstance.currentModel);
                    if (viewerInstance.mixer) {
                        viewerInstance.mixer.stopAllAction();
                        viewerInstance.mixer = null;
                    }
                }
                viewerInstance.currentModel = gltf.scene;
                viewerInstance.scene.add(viewerInstance.currentModel);

                viewerInstance.isWireframe = false;
                viewerInstance.isBackgroundSolid = false;
                viewerInstance.renderer.setClearAlpha(0);
                controlsElement.querySelector('[data-action="toggle-wireframe"]').textContent = 'Wireframe';
                controlsElement.querySelector('[data-action="toggle-background"]').textContent = 'Toggle BG';


                if (gltf.animations && gltf.animations.length) {
                    viewerInstance.mixer = new THREE.AnimationMixer(viewerInstance.currentModel);
                    gltf.animations.forEach((clip) => {
                        viewerInstance.mixer.clipAction(clip).play();
                    });
                } else {
                }

                const box = new THREE.Box3().setFromObject(viewerInstance.currentModel);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = viewerInstance.camera.fov * (Math.PI / 180);
                let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                cameraZ *= 1.5;

                viewerInstance.camera.position.set(center.x, center.y, center.z + cameraZ);
                viewerInstance.controls.target.set(center.x, center.y, center.z);
                viewerInstance.controls.update();

                viewerInstance.initialCameraPosition.copy(viewerInstance.camera.position);
                viewerInstance.initialControlsTarget.copy(viewerInstance.controls.target);
                viewerInstance.initialModelPosition.copy(viewerInstance.currentModel.position);
                viewerInstance.initialModelRotation.copy(viewerInstance.currentModel.rotation);
                viewerInstance.initialModelScale.copy(viewerInstance.currentModel.scale);


                statusElement.innerHTML = '';
                statusElement.classList.add('hidden');
                if (modelFileInput) modelFileInput.style.display = 'block';
                if (modelPath.startsWith('blob:')) {
                    URL.revokeObjectURL(modelPath);
                }

            }, (xhr) => {
                const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                statusElement.innerHTML = `<div class="loading-spinner mb-4"></div><p>Loading: ${percent}%</p>`;
            }, (error) => {
                statusElement.classList.remove('hidden');
                statusElement.innerHTML = `<p class="text-red-500">Error loading model: ${error.message || 'Unknown error'}</p>`;
                if (modelFileInput) modelFileInput.style.display = 'block';
                if (fileInputLabelElement) fileInputLabelElement.classList.remove('hidden');
                if (controlsElement) controlsElement.classList.add('hidden');
                if (audioControlsElement) audioControlsElement.classList.add('hidden');
                if (modelPath.startsWith('blob:')) {
                    URL.revokeObjectURL(modelPath);
                }
            });
        }

        function setupResizeHandle(handle, container, camera, renderer) {
            let isResizing = false;
            let initialX, initialY, initialWidth, initialHeight;

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                initialX = e.clientX;
                initialY = e.clientY;
                initialWidth = container.offsetWidth;
                initialHeight = container.offsetHeight;

                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'nwse-resize';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const minWidth = 300;
                const minHeight = 200;
                const maxWidth = window.innerWidth * 0.9;
                const maxHeight = window.innerHeight * 0.8;

                let newWidth = initialWidth + (e.clientX - initialX);
                let newHeight = initialHeight + (e.clientY - initialY);

                newWidth = Math.max(minWidth, Math.min(newWidth, maxWidth));
                newHeight = Math.max(minHeight, Math.min(newHeight, maxHeight));

                container.style.width = `${newWidth}px`;
                container.style.height = `${newHeight}px`;

                onWindowResize(camera, renderer, container);
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.style.userSelect = '';
                document.body.style.cursor = '';
            });
        }

        function setupModelControls(controlsElement, viewerInstance, containerElement, fileInputLabelElement, uploadMenuElement) {
            const movementStep = 0.1;
            const scaleFactor = 1.05;

            const updateOverlayVisibility = () => {
                const isHovering = containerElement.matches(':hover');
                const isMenuOpen = !uploadMenuElement.classList.contains('hidden');

                if (isHovering || isMenuOpen) {
                    fileInputLabelElement.classList.remove('hidden');
                    if (viewerInstance.currentModel) {
                        controlsElement.classList.remove('hidden');
                    }
                    if (viewerInstance.hasAudioLoaded) {
                        viewerInstance.audioControls.classList.remove('hidden');
                    }
                } else {
                    fileInputLabelElement.classList.add('hidden');
                    controlsElement.classList.add('hidden');
                    viewerInstance.audioControls.classList.add('hidden');
                }
            };

            containerElement.addEventListener('mouseenter', updateOverlayVisibility);
            containerElement.addEventListener('mouseleave', updateOverlayVisibility);

            document.addEventListener('click', (event) => {
                if (!uploadMenuElement.contains(event.target) && event.target !== fileInputLabelElement) {
                    uploadMenuElement.classList.add('hidden');
                    updateOverlayVisibility();
                }
            });

            fileInputLabelElement.addEventListener('click', (event) => {
                event.stopPropagation();
                uploadMenuElement.classList.toggle('hidden');
                updateOverlayVisibility();
            });

            uploadMenuElement.addEventListener('click', (event) => {
                if (event.target.classList.contains('upload-menu-button')) {
                    const type = event.target.dataset.type;
                    uploadMenuElement.classList.add('hidden');

                    if (type === 'model') {
                        fileInputLabelElement.closest('.model-viewer-container').querySelector('input[type="file"][accept=".gltf, .glb"]').click();
                    } else if (type === 'audio') {
                        fileInputLabelElement.closest('.model-viewer-container').querySelector('input[type="file"][accept=".mp3"]').click();
                    }
                    updateOverlayVisibility();
                }
            });

            controlsElement.querySelectorAll('.model-control-button').forEach(button => {
                button.addEventListener('click', () => {
                    const action = button.dataset.action;
                    if (!viewerInstance.currentModel) return;

                    switch (action) {
                        case 'move-up':
                            viewerInstance.currentModel.position.y += movementStep;
                            break;
                        case 'move-down':
                            viewerInstance.currentModel.position.y -= movementStep;
                            break;
                        case 'move-left':
                            viewerInstance.currentModel.position.x -= movementStep;
                            break;
                        case 'move-right':
                            viewerInstance.currentModel.position.x += movementStep;
                            break;
                        case 'toggle-lock':
                            viewerInstance.isCameraLocked = !viewerInstance.isCameraLocked;
                            viewerInstance.controls.enabled = !viewerInstance.isCameraLocked;
                            button.textContent = viewerInstance.isCameraLocked ? 'Unlock Cam' : 'Lock Cam';
                            break;
                        case 'reset-view':
                            viewerInstance.camera.position.copy(viewerInstance.initialCameraPosition);
                            viewerInstance.controls.target.copy(viewerInstance.initialControlsTarget);
                            viewerInstance.currentModel.position.copy(viewerInstance.initialModelPosition);
                            viewerInstance.currentModel.rotation.copy(viewerInstance.initialModelRotation);
                            viewerInstance.currentModel.scale.copy(viewerInstance.initialModelScale);
                            viewerInstance.controls.update();
                            viewerInstance.autoRotate = true;
                            controlsElement.querySelector('[data-action="toggle-rotation"]').textContent = 'Auto-Rotate';
                            viewerInstance.isWireframe = false;
                            viewerInstance.currentModel.traverse((node) => {
                                if (node.isMesh) {
                                    node.material.wireframe = false;
                                }
                            });
                            controlsElement.querySelector('[data-action="toggle-wireframe"]').textContent = 'Wireframe';
                            viewerInstance.isBackgroundSolid = false;
                            viewerInstance.renderer.setClearAlpha(0);
                            controlsElement.querySelector('[data-action="toggle-background"]').textContent = 'Toggle BG';
                            break;
                        case 'toggle-rotation':
                            viewerInstance.autoRotate = !viewerInstance.autoRotate;
                            button.textContent = viewerInstance.autoRotate ? 'Auto-Rotate (Off)' : 'Auto-Rotate (On)';
                            break;
                        case 'scale-up':
                            viewerInstance.currentModel.scale.multiplyScalar(scaleFactor);
                            break;
                        case 'scale-down':
                            viewerInstance.currentModel.scale.multiplyScalar(1 / scaleFactor);
                            break;
                        case 'toggle-background':
                            viewerInstance.isBackgroundSolid = !viewerInstance.isBackgroundSolid;
                            if (viewerInstance.isBackgroundSolid) {
                                viewerInstance.renderer.setClearColor(0x333333, 1);
                                button.textContent = 'Toggle BG (Solid)';
                            } else {
                                viewerInstance.renderer.setClearAlpha(0);
                                button.textContent = 'Toggle BG (Transparent)';
                            }
                            break;
                        case 'toggle-wireframe':
                            viewerInstance.isWireframe = !viewerInstance.isWireframe;
                            viewerInstance.currentModel.traverse((node) => {
                                if (node.isMesh) {
                                    node.material.wireframe = viewerInstance.isWireframe;
                                }
                            });
                            button.textContent = viewerInstance.isWireframe ? 'Wireframe (On)' : 'Wireframe (Off)';
                            break;
                        case 'screenshot':
                            const canvas = viewerInstance.renderer.domElement;
                            const link = document.createElement('a');
                            link.download = 'model-screenshot.png';
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                            link.remove();
                            break;
                    }
                });
            });
        }
    </script>
</body>
</html>
