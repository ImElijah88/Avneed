<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avneed - Your Personal AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInWithPopup, GithubAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null; // Variable to store the authenticated user's ID

        // --- DEBUGGING LINE ADDED HERE ---
        console.log("Firebase Config Loaded:", firebaseConfig);
        // --- END DEBUGGING LINE ---

        // Initialize Firebase and set up authentication state listener
        document.addEventListener('DOMContentLoaded', async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token (Canvas environment).");
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                    }
                } else {
                    console.log("No custom auth token provided. User will need to log in manually.");
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User is logged in:", userId);
                        updateLoginButtons(true);
                        loadUserNotes();
                    } else {
                        userId = null;
                        console.log("User is logged out.");
                        updateLoginButtons(false);
                        document.getElementById('userNotesInput').value = '';
                        document.getElementById('userNotesStatus').textContent = 'Please log in to save notes.';
                    }
                });
            } else {
                console.warn("Firebase config not found. Firebase features will be disabled.");
                document.getElementById('loginBtn').disabled = true;
                document.getElementById('logoutBtn').disabled = true;
                document.getElementById('saveNotesBtn').disabled = true;
                document.getElementById('userNotesInput').disabled = true;
                document.getElementById('userNotesStatus').textContent = 'Firebase not configured.';
            }
        });

        window.loginWithGitHub = async () => {
            const provider = new GithubAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                console.log("Signed in with GitHub!");
            } catch (error) {
                console.error("Error signing in with GitHub:", error);
            }
        };

        window.logoutUser = async () => {
            try {
                await signOut(auth);
                console.log("User signed out.");
            } catch (error) {
                console.error("Error signing out:", error);
            }
        };

        window.saveUserNotes = async () => {
            if (!userId) {
                document.getElementById('userNotesStatus').textContent = 'Please log in to save notes.';
                return;
            }
            if (!db) {
                document.getElementById('userNotesStatus').textContent = 'Firebase not initialized.';
                return;
            }

            const saveNotesBtn = document.getElementById('saveNotesBtn');
            const originalButtonText = saveNotesBtn.textContent;
            const originalButtonBg = saveNotesBtn.style.background;
            const originalButtonBorder = saveNotesBtn.style.borderColor;

            saveNotesBtn.disabled = true;
            saveNotesBtn.innerHTML = `<span class="loading-spinner w-4 h-4 mr-2"></span> Saving...`;
            saveNotesBtn.style.background = '#4a5568';
            saveNotesBtn.style.borderColor = '#4a5568';

            const userNotes = document.getElementById('userNotesInput').value;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private`, 'notes');

            try {
                await setDoc(userDocRef, { content: userNotes, timestamp: new Date() }, { merge: true });
                document.getElementById('userNotesStatus').textContent = 'Notes saved successfully!';
                console.log("User notes saved.");

                saveNotesBtn.innerHTML = `Saved!`;
                saveNotesBtn.style.background = '#22c55e';
                saveNotesBtn.style.borderColor = '#22c55e';

            } catch (error) {
                console.error("Error saving notes:", error);
                document.getElementById('userNotesStatus').textContent = `Error saving notes: ${error.message}`;
                
                saveNotesBtn.innerHTML = `Error!`;
                saveNotesBtn.style.background = '#ef4444';
                saveNotesBtn.style.borderColor = '#ef4444';

            } finally {
                setTimeout(() => {
                    saveNotesBtn.innerHTML = originalButtonText;
                    saveNotesBtn.style.background = originalButtonBg;
                    saveNotesBtn.style.borderColor = originalButtonBorder;
                    saveNotesBtn.disabled = false;
                }, 1500);
            }
        };

        window.loadUserNotes = () => {
            if (!userId || !db) {
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private`, 'notes');

            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('userNotesInput').value = data.content || '';
                    document.getElementById('userNotesStatus').textContent = 'Notes loaded.';
                } else {
                    document.getElementById('userNotesInput').value = '';
                    document.getElementById('userNotesStatus').textContent = 'No notes found. Start typing!';
                }
                console.log("User notes loaded/updated from Firestore.");
            }, (error) => {
                console.error("Error loading notes:", error);
                document.getElementById('userNotesStatus').textContent = `Error loading notes: ${error.message}`;
            });
        };

        window.updateLoginButtons = (isLoggedIn) => {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userNotesInput = document.getElementById('userNotesInput');
            const saveNotesBtn = document.getElementById('saveNotesBtn');
            const notesLoginPrompt = document.getElementById('notesLoginPrompt');

            if (loginBtn && logoutBtn && userNotesInput && saveNotesBtn && notesLoginPrompt) {
                if (isLoggedIn) {
                    loginBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    userNotesInput.disabled = false;
                    saveNotesBtn.disabled = false;
                    notesLoginPrompt.classList.add('hidden');
                } else {
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    userNotesInput.disabled = true;
                    saveNotesBtn.disabled = true;
                    notesLoginPrompt.classList.remove('hidden');
                }
            }
        };
    </script>

    <style>
        /* Base Theme Variables */
        :root {
            --bg-primary: #333333;
            --bg-secondary: #1a1a2e;
            --bg-card: #121212;
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-light-gray: #a0aec0;
            --border-color: #4a5568;
            --input-bg: #1a1a1a;
            --gradient-start: #0f172a;
            --gradient-mid: #1e293b;
            --gradient-end: #334155;
            --color-neon-blue: #00FFFF;
            --color-accent-yellow: #ffd700;
            --modal-bg: rgba(0, 0, 0, 0.8);
            --modal-content-bg: var(--bg-secondary);
        }

        /* Light Theme Variables */
        body.light-theme {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-card: #e2e8f0;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-light-gray: #718096;
            --border-color: #cbd5e1;
            --input-bg: #ffffff;
            --gradient-start: #e0e7ff;
            --gradient-mid: #c3dafe;
            --gradient-end: #a7c5ff;
            --color-neon-blue: #007bff;
            --color-accent-yellow: #ff9800;
            --modal-bg: rgba(255, 255, 255, 0.8);
            --modal-content-bg: var(--bg-secondary);
        }

        /* General Body Styling */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
        }
        
        /* Utility Classes (from Tailwind, with custom variables) */
        .text-neon-blue { color: var(--color-neon-blue); }
        .gradient-bg { background: linear-gradient(to right top, var(--gradient-start), var(--gradient-mid), var(--gradient-end)); }
        
        /* Sphere Button Styling (for 3D model interaction hints) */
        .sphere-button {
            @apply w-20 h-20 rounded-full flex items-center justify-center text-white font-bold text-base shadow-lg transition duration-300 ease-in-out transform hover:scale-110;
            background: #2d3748;
            border: 2px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            flex-shrink: 0;
        }
        .sphere-button:hover {
            background: #374151;
            box-shadow: 0 0 25px 8px rgba(255, 215, 0, 0.7), 0 0 10px 2px rgba(255, 215, 0, 0.4);
            border-color: var(--color-accent-yellow);
        }

        .ai-button {
            @apply px-4 py-2 rounded-full text-white font-bold text-sm shadow-lg transition duration-300 ease-in-out transform hover:scale-105;
            background: #2d3748;
            border: 2px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            pointer-events: auto;
        }
        .ai-button:hover {
            background: #374151;
            box-shadow: 0 0 25px 8px rgba(255, 215, 0, 0.7), 0 0 10px 2px rgba(255, 215, 0, 0.4);
            border-color: var(--color-accent-yellow);
        }

        .ai-button.selected-button {
            background: var(--color-neon-blue);
            color: var(--bg-primary);
            border-color: var(--color-neon-blue);
            box-shadow: 0 0 20px var(--color-neon-blue), 0 0 30px var(--color-neon-blue);
            transform: scale(1.02);
        }
        .ai-button.selected-button:hover {
            background: var(--color-neon-blue);
            color: var(--bg-primary);
            box-shadow: 0 0 25px var(--color-neon-blue), 0 0 40px var(--color-neon-blue);
            border-color: var(--color-neon-blue);
        }

        .card {
            background-color: var(--bg-card);
            @apply p-6 rounded-[2rem] shadow-xl transition duration-300 ease-in-out;
            border: 1px solid rgba(74, 85, 104, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }
        .input-field {
            background-color: var(--input-bg);
            color: var(--text-primary);
            @apply p-3 rounded-xl border border-gray-700 focus:outline-none focus:ring-4 focus:ring-purple-600 transition duration-200 ease-in-out;
            border-color: var(--border-color);
            font-size: 0.9rem;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--color-accent-yellow);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .text-gray-100 { color: var(--text-primary); }
        .text-gray-200 { color: var(--text-secondary); }
        .text-gray-300 { color: var(--text-light-gray); }
        .text-gray-400 { color: var(--text-light-gray); }
        .text-gray-500 { color: var(--text-light-gray); }
        .text-gray-700 { border-color: var(--border-color); }
        .bg-gray-800 { background-color: var(--bg-card); }
        .bg-gray-900 { background-color: var(--bg-secondary); }
        .bg-gray-950 { background-color: var(--bg-card); }

        .text-yellow-400 { color: var(--color-accent-yellow); }

        #chatHistory p {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0.4rem;
            padding: 0.6rem;
            border-radius: 0.6rem;
            max-width: 80%;
        }

        #chatHistory p.user-message {
            margin-left: auto;
            background-color: var(--color-neon-blue);
            color: var(--bg-primary);
            font-weight: 600;
            border-bottom-right-radius: 0.25rem;
        }
        #chatHistory p.ai-message {
            margin-right: auto;
            background-color: var(--bg-card);
            color: var(--text-primary);
            border-bottom-left-radius: 0.25rem;
        }

        #aiInputText, #imagePromptInput, #videoPromptInput, #userNotesInput {
            min-height: 2rem;
            max-height: 120px;
            overflow-y: hidden;
            box-sizing: border-box;
        }

        .image-frame-container, .video-player-container {
            background-color: var(--bg-card);
            border: 3px solid var(--color-neon-blue);
            border-radius: 1rem;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5),
                        0 0 20px rgba(0, 255, 255, 0.3) inset,
                        0 10px 20px rgba(0, 0, 0, 0.5);
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease-in-out;
            transform: rotateZ(-0.5deg);
            max-width: 100%;
            margin: 0 auto;
            animation: neon-pulse-frame 2s infinite alternate;
        }

        @keyframes neon-pulse-frame {
            0% {
                box-shadow: 0 0 10px rgba(0, 255, 255, 0.5),
                            0 0 20px rgba(0, 255, 255, 0.3) inset,
                            0 10px 20px rgba(0, 0, 0, 0.5);
            }
            100% {
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.7),
                            0 0 30px rgba(0, 255, 255, 0.5) inset,
                            0 10px 20px rgba(0, 0, 0, 0.7);
            }
        }

        .image-frame-container::before, .video-player-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: repeating-linear-gradient(0deg, rgba(0, 255, 255, 0.03) 0px, rgba(0, 255, 255, 0.03) 1px, transparent 1px, transparent 15px),
                              repeating-linear-gradient(90deg, rgba(0, 255, 255, 0.03) 0px, rgba(0, 255, 255, 0.03) 1px, transparent 1px, transparent 15px);
            pointer-events: none;
            z-index: 1;
            border-radius: 0.8rem;
        }

        .generated-image, .generated-video {
            position: relative;
            z-index: 2;
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0.3rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4) inset;
            transition: opacity 0.3s ease-in-out;
        }

        .image-frame-container.aspect-1-1 { width: 300px; height: 300px; }
        .image-frame-container.aspect-16-9 { width: 480px; height: 270px; }
        .image-frame-container.aspect-4-3 { width: 400px; height: 300px; }
        .image-frame-container.aspect-9-16 { width: 270px; height: 480px; }

        .video-player-container.aspect-16-9 { width: 480px; height: 270px; }

        @media (max-width: 768px) {
            .image-frame-container.aspect-1-1 { width: 250px; height: 250px; }
            .image-frame-container.aspect-16-9 { width: 85%; height: calc(85vw * 9 / 16); max-height: 250px; }
            .image-frame-container.aspect-4-3 { width: 85%; height: calc(85vw * 3 / 4); max-height: 250px; }
            .image-frame-container.aspect-9-16 { width: calc(85vw * 9 / 16); height: 85vw; max-width: 180px; max-height: 300px; }
            .video-player-container.aspect-16-9 { width: 85%; height: calc(85vw * 9 / 16); max-height: 250px; }
        }

        .image-loading-overlay, .video-loading-overlay {
            font-size: 1rem;
        }

        .image-loading-spinner, .video-loading-spinner {
            width: 40px;
            height: 40px;
            margin-bottom: 0.8rem;
        }

        .main-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            box-sizing: border-box;
            pointer-events: none;
        }

        .header-ui {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            pointer-events: auto;
        }

        .footer-ui {
            width: 100%;
            text-align: center;
            color: var(--text-light-gray);
            font-size: 0.8rem;
            pointer-events: auto;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: auto;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--modal-content-bg);
            padding: 1.5rem;
            border-radius: 2rem;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-50px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .modal-overlay.visible .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-close-button {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            z-index: 1010;
            pointer-events: auto;
        }
        .modal-close-button:hover {
            background: var(--color-neon-blue);
            color: var(--bg-primary);
            border-color: var(--color-neon-blue);
            transform: scale(1.1);
        }

        .ai-feature-section h2, .main-menu-section h2 {
            font-size: 2.2rem;
            margin-bottom: 1.5rem;
        }

        .ai-feature-section p, .main-menu-section p {
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .ai-feature-section .card, .main-menu-section .card {
            padding: 1.5rem;
            border-radius: 1.5rem;
        }
    </style>
</head>
<body class="dark-theme">
    <div class="main-container">
        <!-- 3D Canvas Container -->
        <div class="canvas-container">
            <canvas id="mainCanvas"></canvas>
        </div>

        <!-- UI Overlay -->
        <div class="ui-overlay">
            <div class="header-ui">
                <button id="toggleThemeBtn" class="ai-button">Theme</button>
                <button id="toggleLanguageBtn" class="ai-button">Lang</button>
            </div>

            <div class="text-center">
                <h1 class="text-4xl font-extrabold tracking-tight text-neon-blue drop-shadow-lg">Avneed</h1>
                <p class="text-lg text-gray-300 mt-2">Click shapes for interaction</p>
            </div>

            <div class="footer-ui">
                <p>&copy; 2025 Avneed. All rights reserved.</p>
            </div>
        </div>
    </div>

    <!-- Modals (Initially Hidden) -->
    <div id="mainModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" id="closeModalBtn">&times;</button>
            <div id="modalContentArea">
                <!-- Content will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- Main Menu Section (Content for a Modal) -->
    <section id="main-menu-section" class="ai-feature-section" style="display: none;">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6 text-gray-100 leading-tight">Main Menu</h2>
            <div class="max-w-4xl mx-auto bg-gray-900 p-6 rounded-2xl shadow-xl border border-gray-700">
                <div class="flex flex-col gap-4 mb-6">
                    <button id="loginBtn" class="ai-button" onclick="loginWithGitHub()">Log In (GitHub)</button>
                    <button id="logoutBtn" class="ai-button hidden" onclick="logoutUser()">Log Out</button>
                    
                    <h3 class="text-xl font-bold text-yellow-400 mt-4">Your Private Notes</h3>
                    <p id="notesLoginPrompt" class="text-sm text-gray-300 mb-2">
                        Log in to save and load your personal notes.
                    </p>
                    <textarea id="userNotesInput" class="input-field resize-none" placeholder="Type your private notes here..." disabled></textarea>
                    <button id="saveNotesBtn" class="ai-button" onclick="saveUserNotes()" disabled>Save Notes</button>
                    <p id="userNotesStatus" class="mt-2 text-center text-gray-400 text-xs">Please log in to save notes.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- AI Chatbot Section (Content for a Modal) -->
    <section id="ai-chatbot-section" class="ai-feature-section" style="display: none;">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6 text-gray-100 leading-tight">Chatbot</h2>
            <div class="max-w-4xl mx-auto bg-gray-900 p-6 rounded-2xl shadow-xl border border-gray-700">
                <p id="chatInstructions" class="text-sm text-gray-300 mb-4">
                    Chat or upload a file (.txt, .doc, .pdf).
                    <br><span class="text-xs text-gray-400">(Plain text only from files.)</span>
                </p>
                <div id="chatHistory" class="bg-[#1a1a1a] p-4 rounded-xl shadow-md text-left text-gray-200 min-h-[200px] max-h-[300px] overflow-y-auto mb-4 border border-gray-700">
                    <p class="text-gray-400" id="initialChatMessage">Hello! How can I assist?</p>
                </div>
                
                <div class="flex gap-2 mb-2">
                    <textarea id="aiInputText" class="flex-grow input-field resize-none" placeholder="Type message..."></textarea>
                    <label for="aiFileInput" id="aiFileInputLabel" class="ai-button flex-shrink-0 flex items-center justify-center">Upload</label>
                    <input type="file" id="aiFileInput" accept=".txt, .doc, .docx, .pdf" class="hidden-file-input">
                    <button id="sendBtn" class="ai-button flex-shrink-0">Send</button>
                </div>

                <div id="loadingIndicator" class="mt-2 text-center hidden">
                    <div class="loading-spinner"></div>
                    <p class="ml-1 text-gray-300 inline-block text-xs">Thinking...</p>
                </div>
                <div id="errorMessage" class="mt-2 text-center text-red-500 hidden text-xs">
                    <p id="errorMessageText">Error. Try again.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Image Generator Section (Content for a Modal) -->
    <section id="image-generator-section" class="ai-feature-section" style="display: none;">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6 text-gray-100 leading-tight">Image</h2>
            <div class="max-w-4xl mx-auto bg-gray-900 p-6 rounded-2xl shadow-xl border border-gray-700">
                <p id="imageGeneratorInstructions" class="text-sm text-gray-300 mb-4">
                    Describe image. Choose aspect ratio.
                </p>
                
                <div class="flex flex-col gap-4 mb-6">
                    <textarea id="imagePromptInput" class="flex-grow input-field resize-none" placeholder="e.g., 'Futuristic city, sunset, flying cars, cyberpunk'"></textarea>
                    
                    <div class="flex flex-wrap justify-center gap-2 mb-4" id="aspectRatioButtons">
                        <button class="ai-button text-xs px-4 py-2" data-aspect="1-1">1:1</button>
                        <button class="ai-button text-xs px-4 py-2" data-aspect="16-9">16:9</button>
                        <button class="ai-button text-xs px-4 py-2" data-aspect="4-3">4:3</button>
                        <button class="ai-button text-xs px-4 py-2" data-aspect="9-16">9:16</button>
                    </div>

                    <button id="generateImageBtn" class="ai-button">Generate</button>
                </div>

                <div id="imageOutputArea" class="mt-4 flex justify-center items-center relative min-h-[250px]">
                    <div id="imageFrame" class="image-frame-container aspect-1-1">
                        <img id="generatedImage" class="generated-image" src="https://placehold.co/300x300/333333/FFFFFF?text=Image+Here" alt="Generated Image Placeholder">
                        <div id="imageLoadingOverlay" class="image-loading-overlay hidden">
                            <span class="image-loading-spinner"></span>
                            <p id="imageLoadingText">Generating...</p>
                        </div>
                    </div>
                </div>

                <div id="imageErrorMessage" class="mt-2 text-center text-red-500 hidden text-xs">
                    <p id="errorMessageText">Error. Try again.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Video Generator Section (Content for a Modal) -->
    <section id="video-generator-section" class="ai-feature-section" style="display: none;">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6 text-gray-100 leading-tight">Video</h2>
            <div class="max-w-4xl mx-auto bg-gray-900 p-6 rounded-2xl shadow-xl border border-gray-700">
                <p id="videoGeneratorInstructions" class="text-sm text-gray-300 mb-4">
                    Describe video.
                    <br><span class="text-xs text-gray-400">(Demo placeholder.)</span>
                </p>
                
                <div class="flex flex-col gap-4 mb-6">
                    <textarea id="videoPromptInput" class="flex-grow input-field resize-none" placeholder="e.g., 'Robot walking, neon city'"></textarea>
                    
                    <button id="generateVideoBtn" class="ai-button">Generate</button>
                </div>

                <div id="videoOutputArea" class="mt-4 flex justify-center items-center relative min-h-[250px]">
                    <div id="videoPlayerFrame" class="video-player-container aspect-16-9">
                        <video id="generatedVideo" class="generated-video" controls poster="https://placehold.co/480x270/333333/FFFFFF?text=Video+Here">
                            <source src="" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <div id="videoLoadingOverlay" class="video-loading-overlay hidden">
                            <span class="video-loading-spinner"></span>
                            <p id="videoLoadingText">Generating...</p>
                        </div>
                    </div>
                </div>

                <div id="videoErrorMessage" class="mt-2 text-center text-red-500 hidden text-xs">
                    <p id="errorMessageText">Error. Try again.</p>
                </div>
            </div>
        </div>
    </section>

    <script>
        // --- THREE.JS GLOBALS ---
        let scene, camera, renderer, raycaster, mouse;
        let chatbotSphere, menuBox;
        let orbitControls;
        const models = [];

        // Drag and Drop variables
        let isDragging = false;
        let draggedObject = null;
        let plane = new THREE.Plane();
        let pNormal = new THREE.Vector3(0, 0, 1);
        let worldPosition = new THREE.Vector3();
        let offset = new THREE.Vector3();
        let originalMaterial = null;
        let initialClickPosition = { x: 0, y: 0 };
        const CLICK_THRESHOLD = 5;

        // --- DOM ELEMENTS ---
        const mainCanvas = document.getElementById('mainCanvas');
        const mainModal = document.getElementById('mainModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalContentArea = document.getElementById('modalContentArea');

        // Main Menu Elements
        const mainMenuSection = document.getElementById('main-menu-section');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userNotesInput = document.getElementById('userNotesInput');
        const saveNotesBtn = document.getElementById('saveNotesBtn');
        const userNotesStatus = document.getElementById('userNotesStatus');
        const notesLoginPrompt = document.getElementById('notesLoginPrompt');

        // Chatbot Elements
        const aiChatbotSection = document.getElementById('ai-chatbot-section');
        const aiInputText = document.getElementById('aiInputText');
        const aiFileInput = document.getElementById('aiFileInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatHistoryDiv = document.getElementById('chatHistory');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        let chatHistory = [{ role: "model", parts: [{ text: "Hello! How can I assist?" }] }];
        
        // Image Generator Elements
        const imageGeneratorSection = document.getElementById('image-generator-section');
        const imagePromptInput = document.getElementById('imagePromptInput');
        const aspectRatioButtons = document.getElementById('aspectRatioButtons');
        const generateImageBtn = document.getElementById('generateImageBtn');
        const imageFrame = document.getElementById('imageFrame');
        const generatedImage = document.getElementById('generatedImage');
        const imageLoadingOverlay = document.getElementById('imageLoadingOverlay');
        const imageLoadingText = document.getElementById('imageLoadingText');
        const imageErrorMessage = document.getElementById('imageErrorMessage');
        let selectedAspectRatio = '1-1';

        // Video Generator Elements
        const videoGeneratorSection = document.getElementById('video-generator-section');
        const videoPromptInput = document.getElementById('videoPromptInput');
        const generateVideoBtn = document.getElementById('generateVideoBtn');
        const videoPlayerFrame = document.getElementById('videoPlayerFrame');
        const generatedVideo = document.getElementById('generatedVideo');
        const videoLoadingOverlay = document.getElementById('videoLoadingOverlay');
        const videoLoadingText = document.getElementById('videoLoadingText');
        const videoErrorMessage = document.getElementById('videoErrorMessage');

        // Theme and Language Toggles
        const toggleThemeBtn = document.getElementById('toggleThemeBtn');
        const toggleLanguageBtn = document.getElementById('toggleLanguageBtn');
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let currentLanguage = localStorage.getItem('language') || 'en';

        // Store original parent of each section for re-attachment
        const originalParents = new Map();
        originalParents.set('main-menu-section', mainMenuSection.parentNode);
        originalParents.set('ai-chatbot-section', aiChatbotSection.parentNode);
        originalParents.set('image-generator-section', imageGeneratorSection.parentNode);
        originalParents.set('video-generator-section', videoGeneratorSection.parentNode);

        // --- TRANSLATIONS ---
        const translations = {
            en: {
                toggleTheme: 'Theme',
                toggleLanguage: 'Lang',
                mainMenuTitle: 'Main Menu',
                loginBtn: 'Log In (GitHub)',
                logoutBtn: 'Log Out',
                yourPrivateNotes: 'Your Private Notes',
                notesLoginPrompt: 'Log in to save and load your personal notes.',
                typeNotesPlaceholder: 'Type your private notes here...',
                saveNotes: 'Save Notes',
                notesLoginStatus: 'Please log in to save notes.',
                notesSavedSuccess: 'Notes saved successfully!',
                notesSaveError: 'Error saving notes:',
                notesLoaded: 'Notes loaded.',
                noNotesFound: 'No notes found. Start typing!',
                firebaseNotInit: 'Firebase not configured.',
                chatbotTitle: 'Chatbot',
                chatInstructions: 'Chat or upload a file (.txt, .doc, .pdf).<br><span class="text-xs text-gray-400">(Plain text only from files.)</span>',
                initialChatMessage: 'Hello! How can I assist?',
                typeMessage: 'Type message...',
                uploadFile: 'Upload',
                send: 'Send',
                avneedThinking: 'Thinking...',
                errorOccurred: 'Error. Try again.',
                errorReadingFile: 'Error reading file.',
                imageGeneratorTitle: 'Image',
                imageGeneratorInstructions: 'Describe image. Choose aspect ratio.',
                square: '1:1',
                landscape: '16:9',
                standard: '4:3',
                portrait: '9:16',
                generateImage: 'Generate',
                generatingImage: 'Generating...',
                imageGenError: 'Error. Try again.',
                imageGenFailed: 'Image generation failed.',
                videoGeneratorTitle: 'Video',
                videoGeneratorInstructions: 'Describe video.<br><span class="text-xs text-gray-400">(Demo placeholder.)</span>',
                generateVideo: 'Generate',
                generatingVideo: 'Generating...',
                videoGenError: 'Error. Try again.',
            },
            es: {
                toggleTheme: 'Tema',
                toggleLanguage: 'Idioma',
                mainMenuTitle: 'Menú Principal',
                loginBtn: 'Iniciar Sesión (GitHub)',
                logoutBtn: 'Cerrar Sesión',
                yourPrivateNotes: 'Tus Notas Privadas',
                notesLoginPrompt: 'Inicia sesión para guardar y cargar tus notas personales.',
                typeNotesPlaceholder: 'Escribe tus notas privadas aquí...',
                saveNotes: 'Guardar Notas',
                notesLoginStatus: 'Inicia sesión para guardar notas.',
                notesSavedSuccess: '¡Notas guardadas con éxito!',
                notesSaveError: 'Error al guardar notas:',
                notesLoaded: 'Notas cargadas.',
                noNotesFound: 'No se encontraron notas. ¡Empieza a escribir!',
                firebaseNotInit: 'Firebase no configurado.',
                chatbotTitle: 'Chatbot',
                chatInstructions: 'Chatea o sube un archivo (.txt, .doc, .pdf).<br><span class="text-xs text-gray-400">(Solo texto sin formato de archivos.)</span>',
                initialChatMessage: '¡Hola! ¿Cómo puedo ayudar?',
                typeMessage: 'Escribe mensaje...',
                uploadFile: 'Subir',
                send: 'Enviar',
                avneedThinking: 'Pensando...',
                errorOccurred: 'Error. Intenta de nuevo.',
                errorReadingFile: 'Error al leer el archivo.',
                imageGeneratorTitle: 'Imagen',
                imageGeneratorInstructions: 'Describe imagen. Elige relación de aspecto.',
                square: '1:1',
                landscape: '16:9',
                standard: '4:3',
                portrait: '9:16',
                generateImage: 'Generar',
                generatingImage: 'Generando...',
                imageGenError: 'Error. Intenta de nuevo.',
                imageGenFailed: 'Fallo al generar imagen.',
                videoGeneratorInstructions: 'Describe video.<br><span class="text-xs text-gray-400">(Demostración.)</span>',
                generateVideo: 'Generar',
                generatingVideo: 'Generando...',
                videoGenError: 'Error. Intenta de nuevo.',
            }
        };

        // --- THEME AND LANGUAGE FUNCTIONS ---
        function applyTheme(theme) {
            document.body.classList.remove('dark-theme', 'light-theme');
            document.body.classList.add(theme + '-theme');
            currentTheme = theme;
            localStorage.setItem('theme', theme);
        }

        function applyLanguage(lang) {
            const currentTranslations = translations[lang];
            if (!currentTranslations) return;

            toggleThemeBtn.textContent = currentTranslations.toggleTheme;
            toggleLanguageBtn.textContent = currentTranslations.toggleLanguage;

            document.querySelector('#main-menu-section h2').textContent = currentTranslations.mainMenuTitle;
            loginBtn.textContent = currentTranslations.loginBtn;
            logoutBtn.textContent = currentTranslations.logoutBtn;
            document.querySelector('#main-menu-section h3').textContent = currentTranslations.yourPrivateNotes;
            notesLoginPrompt.textContent = currentTranslations.notesLoginPrompt;
            userNotesInput.placeholder = currentTranslations.typeNotesPlaceholder;
            saveNotesBtn.textContent = currentTranslations.saveNotes;
            userNotesStatus.textContent = currentTranslations.notesLoginStatus;

            document.querySelector('#ai-chatbot-section h2').textContent = currentTranslations.chatbotTitle;
            chatInstructions.innerHTML = currentTranslations.chatInstructions;
            initialChatMessage.textContent = currentTranslations.initialChatMessage;
            aiInputText.placeholder = currentTranslations.typeMessage;
            aiFileInputLabel.textContent = currentTranslations.uploadFile;
            sendBtn.textContent = currentTranslations.send;
            loadingIndicator.querySelector('p').textContent = currentTranslations.avneedThinking;
            errorMessage.querySelector('p').textContent = currentTranslations.errorOccurred;
            
            document.querySelector('#image-generator-section h2').textContent = currentTranslations.imageGeneratorTitle;
            imageGeneratorInstructions.textContent = currentTranslations.imageGeneratorInstructions;
            document.querySelector('#aspectRatioButtons button[data-aspect="1-1"]').textContent = currentTranslations.square;
            document.querySelector('#aspectRatioButtons button[data-aspect="16-9"]').textContent = currentTranslations.landscape;
            document.querySelector('#aspectRatioButtons button[data-aspect="4-3"]').textContent = currentTranslations.standard;
            document.querySelector('#aspectRatioButtons button[data-aspect="9-16"]').textContent = currentTranslations.portrait;
            generateImageBtn.textContent = currentTranslations.generateImage;
            imageLoadingText.textContent = currentTranslations.generatingImage;
            imageErrorMessage.querySelector('p').textContent = currentTranslations.imageGenError;
            imagePromptInput.placeholder = 'e.g., ' + currentTranslations.imageGeneratorInstructions.split('.')[0].replace('Describe image', 'Futuristic city, sunset, flying cars, cyberpunk');

            document.querySelector('#video-generator-section h2').textContent = currentTranslations.videoGeneratorTitle;
            videoGeneratorInstructions.innerHTML = currentTranslations.videoGeneratorInstructions;
            generateVideoBtn.textContent = currentTranslations.generateVideo;
            videoLoadingText.textContent = currentTranslations.generatingVideo;
            videoErrorMessage.querySelector('p').textContent = currentTranslations.videoGenError;
            videoPromptInput.placeholder = 'e.g., ' + currentTranslations.videoGeneratorInstructions.split('<br>')[0].replace('Describe video.', 'Robot walking, neon city');

            currentLanguage = lang;
            localStorage.setItem('language', lang);
        }

        applyTheme(currentTheme);
        applyLanguage(currentLanguage);

        toggleThemeBtn.addEventListener('click', () => {
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });

        toggleLanguageBtn.addEventListener('click', () => {
            applyLanguage(currentLanguage === 'en' ? 'es' : 'en');
        });

        // --- MODAL LOGIC ---
        function openModal(sectionElement) {
            modalContentArea.innerHTML = '';
            modalContentArea.appendChild(sectionElement);
            sectionElement.style.display = 'block';
            mainModal.classList.add('visible');
            modalContentArea.scrollTop = 0;
            applyLanguage(currentLanguage);
        }

        function closeModal() {
            mainModal.classList.remove('visible');
            const currentSection = modalContentArea.firstElementChild;
            if (currentSection && originalParents.has(currentSection.id)) {
                originalParents.get(currentSection.id).appendChild(currentSection);
                currentSection.style.display = 'none';
            }
            modalContentArea.innerHTML = '';
        }

        closeModalBtn.addEventListener('click', closeModal);
        mainModal.addEventListener('click', (event) => {
            if (event.target === mainModal) {
                closeModal();
            }
        });

        // --- CHATBOT LOGIC ---
        function displayMessage(role, text) {
            const messageElement = document.createElement('p');
            messageElement.classList.add('mb-2', 'p-3', 'rounded-lg', 'max-w-[75%]');
            
            if (role === 'user') {
                messageElement.classList.add('user-message');
            } else {
                messageElement.classList.add('ai-message');
            }
            messageElement.textContent = text;
            chatHistoryDiv.appendChild(messageElement);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        async function sendChatMessage() {
            const userMessage = aiInputText.value.trim();
            if (!userMessage) return;

            displayMessage('user', userMessage);
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            aiInputText.value = '';

            aiInputText.style.height = 'auto';

            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    displayMessage('model', aiResponse);
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                } else {
                    displayMessage('model', translations[currentLanguage].errorOccurred);
                }
            } catch (error) {
                errorMessage.classList.remove('hidden');
                errorMessage.querySelector('p').textContent = translations[currentLanguage].errorOccurred + ` (${error.message})`;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        sendBtn.addEventListener('click', sendChatMessage);
        aiInputText.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        });

        aiInputText.addEventListener('input', () => {
            aiInputText.style.height = 'auto';
            aiInputText.style.height = (aiInputText.scrollHeight) + 'px';
            if (aiInputText.scrollHeight > aiInputText.clientHeight) {
                aiInputText.style.overflowY = 'auto';
            } else {
                aiInputText.style.overflowY = 'hidden';
            }
        });

        aiFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileContent = e.target.result;
                    aiInputText.value = `File content:\n\n${fileContent}\n\nMy question: `;
                    aiInputText.focus();
                    aiInputText.dispatchEvent(new Event('input'));
                };
                reader.onerror = () => {
                    errorMessage.classList.remove('hidden');
                    errorMessage.textContent = translations[currentLanguage].errorReadingFile;
                };
                reader.readAsText(file);
            }
        });

        // --- IMAGE GENERATOR LOGIC ---
        aspectRatioButtons.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                aspectRatioButtons.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('selected-button');
                });

                event.target.classList.add('selected-button');
                selectedAspectRatio = event.target.dataset.aspect;

                imageFrame.classList.remove('aspect-1-1', 'aspect-16-9', 'aspect-4-3', 'aspect-9-16');
                imageFrame.classList.add(`aspect-${selectedAspectRatio}`);
            }
        });

        document.querySelector('#aspectRatioButtons button[data-aspect="1-1"]').classList.add('selected-button');

        generateImageBtn.addEventListener('click', async () => {
            const prompt = imagePromptInput.value.trim();
            if (!prompt) {
                imageErrorMessage.classList.remove('hidden');
                imageErrorMessage.querySelector('p').textContent = translations[currentLanguage].imageGenError;
                return;
            }

            imageLoadingOverlay.classList.remove('hidden');
            generatedImage.style.opacity = '0.5';
            imageErrorMessage.classList.add('hidden');
            
            generateImageBtn.classList.add('selected-button');
            generateImageBtn.disabled = true;
            generateImageBtn.innerHTML = `<span class="loading-spinner w-5 h-5 mr-2"></span> ${translations[currentLanguage].generatingImage}`;

            const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1} };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    generatedImage.src = imageUrl;
                    generatedImage.alt = prompt;
                    generatedImage.style.opacity = '1';
                } else {
                    imageErrorMessage.classList.remove('hidden');
                    imageErrorMessage.querySelector('p').textContent = translations[currentLanguage].imageGenFailed;
                }
            } catch (error) {
                console.error("Error generating image:", error);
                imageErrorMessage.classList.remove('hidden');
                imageErrorMessage.querySelector('p').textContent = `${translations[currentLanguage].imageGenError} (${error.message}).`;
            } finally {
                imageLoadingOverlay.classList.add('hidden');
                generateImageBtn.classList.remove('selected-button');
                generateImageBtn.disabled = false;
                generateImageBtn.textContent = translations[currentLanguage].generateImage;
            }
        });

        imagePromptInput.addEventListener('input', () => {
            imagePromptInput.style.height = 'auto';
            imagePromptInput.style.height = (imagePromptInput.scrollHeight) + 'px';
            if (imagePromptInput.scrollHeight > imagePromptInput.clientHeight) {
                imagePromptInput.style.overflowY = 'auto';
            } else {
                imagePromptInput.style.overflowY = 'hidden';
            }
        });

        // --- VIDEO GENERATOR LOGIC ---
        generateVideoBtn.addEventListener('click', async () => {
            const prompt = videoPromptInput.value.trim();
            if (!prompt) {
                videoErrorMessage.classList.remove('hidden');
                videoErrorMessage.querySelector('p').textContent = translations[currentLanguage].videoGenError;
                return;
            }

            videoLoadingOverlay.classList.remove('hidden');
            generatedVideo.style.opacity = '0.5';
            videoErrorMessage.classList.add('hidden');
            
            generateVideoBtn.classList.add('selected-button');
            generateVideoBtn.disabled = true;
            generateVideoBtn.innerHTML = `<span class="loading-spinner w-5 h-5 mr-2"></span> ${translations[currentLanguage].generatingVideo}`;

            try {
                await new Promise(resolve => setTimeout(resolve, 3000)); 
                
                generatedVideo.src = "https://www.w3schools.com/html/mov_bbb.mp4";
                generatedVideo.load();
                generatedVideo.play();
                generatedVideo.style.opacity = '1';

            } catch (error) {
                console.error("Error generating video (simulated):", error);
                videoErrorMessage.classList.remove('hidden');
                videoErrorMessage.querySelector('p').textContent = translations[currentLanguage].videoGenError;
            } finally {
                videoLoadingOverlay.classList.add('hidden');
                generateVideoBtn.classList.remove('selected-button');
                generateVideoBtn.disabled = false;
                generateVideoBtn.textContent = translations[currentLanguage].generateVideo;
            }
        });

        videoPromptInput.addEventListener('input', () => {
            videoPromptInput.style.height = 'auto';
            videoPromptInput.style.height = (videoPromptInput.scrollHeight) + 'px';
            if (videoPromptInput.scrollHeight > videoPromptInput.clientHeight) {
                videoPromptInput.style.overflowY = 'auto';
            } else {
                videoPromptInput.style.overflowY = 'hidden';
            }
        });

        // --- THREE.JS SCENE SETUP ---
        function init3DScene() {
            scene = new THREE.Scene();
            scene.background = null;

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 10);

            renderer = new THREE.WebGLRenderer({ canvas: mainCanvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearAlpha(0);

            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambientLight);
            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight1.position.set(5, 10, 5).normalize();
            scene.add(directionalLight1);
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.7);
            directionalLight2.position.set(-5, -10, -5).normalize();
            scene.add(directionalLight2);

            orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
            orbitControls.enableDamping = true;
            orbitControls.dampingFactor = 0.25;
            orbitControls.screenSpacePanning = false;
            orbitControls.maxPolarAngle = Math.PI / 2;

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            mainCanvas.addEventListener('pointerdown', onPointerDown, false);
            mainCanvas.addEventListener('pointermove', onPointerMove, false);
            mainCanvas.addEventListener('pointerup', onPointerUp, false);

            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);

            positionShapesInCorners();
        }

        function animate3D() {
            requestAnimationFrame(animate3D);

            if (chatbotSphere) chatbotSphere.rotation.y += 0.005;
            if (menuBox) menuBox.rotation.y -= 0.003;

            orbitControls.update();
            renderer.render(scene, camera);
        }

        function createShape(geometry, material, name) {
            const mesh = new THREE.Mesh(geometry, material);
            mesh.name = name;
            scene.add(mesh);
            models.push(mesh);
            console.log(`Created ${name} shape.`);
            return mesh;
        }

        function positionShapesInCorners() {
            const aspect = window.innerWidth / window.innerHeight;
            const frustumHeight = 2 * Math.tan(camera.fov * 0.5 * Math.PI / 180) * camera.position.z;
            const frustumWidth = frustumHeight * aspect;

            const marginX = 2.5;
            const marginY = 2.5;

            if (chatbotSphere) {
                chatbotSphere.position.set(-frustumWidth / 2 + marginX, frustumHeight / 2 - marginY, 0);
            }
            if (menuBox) {
                menuBox.position.set(frustumWidth / 2 - marginX, -frustumHeight / 2 + marginY, 0);
            }
        }

        function getNormalizedMouseCoordinates(event) {
            return {
                x: (event.clientX / window.innerWidth) * 2 - 1,
                y: - (event.clientY / window.innerHeight) * 2 + 1
            };
        }

        function onPointerDown(event) {
            event.preventDefault();
            initialClickPosition = { x: event.clientX, y: event.clientY };
            isDragging = false;

            const coords = getNormalizedMouseCoordinates(event);
            raycaster.setFromCamera(coords, camera);

            const intersects = raycaster.intersectObjects(models);

            if (intersects.length > 0) {
                draggedObject = intersects[0].object;
                originalMaterial = draggedObject.material;
                
                const highlightColor = draggedObject.name === 'chatbot' ? 0x00FFFF : 0xFFD700;
                draggedObject.material = new THREE.MeshPhongMaterial({ color: highlightColor, emissive: highlightColor, emissiveIntensity: 1.5 });

                plane.setFromNormalAndCoplanarPoint(camera.getWorldDirection(plane.normal), draggedObject.position);
                if (raycaster.ray.intersectPlane(plane, worldPosition)) {
                    offset.copy(worldPosition).sub(draggedObject.position);
                }
                
                orbitControls.enabled = false;
            }
        }

        function onPointerMove(event) {
            if (draggedObject) {
                const currentX = event.clientX;
                const currentY = event.clientY;
                const dx = Math.abs(currentX - initialClickPosition.x);
                const dy = Math.abs(currentY - initialClickPosition.y);

                if (dx > CLICK_THRESHOLD || dy > CLICK_THRESHOLD) {
                    isDragging = true;
                }

                const coords = getNormalizedMouseCoordinates(event);
                raycaster.setFromCamera(coords, camera);

                if (raycaster.ray.intersectPlane(plane, worldPosition)) {
                    draggedObject.position.copy(worldPosition.sub(offset));
                }
            }
        }

        function onPointerUp(event) {
            if (draggedObject) {
                draggedObject.material = originalMaterial;

                const finalX = event.clientX;
                const finalY = event.clientY;
                const totalDx = Math.abs(finalX - initialClickPosition.x);
                const totalDy = Math.abs(finalY - initialClickPosition.y);

                if (totalDx <= CLICK_THRESHOLD && totalDy <= CLICK_THRESHOLD) {
                    if (draggedObject.name === 'chatbot') {
                        console.log('Chatbot sphere clicked! Opening Chatbot.');
                        openModal(aiChatbotSection);
                    } else if (draggedObject.name === 'menu') {
                        console.log('Menu box clicked! Opening Main Menu.');
                        openModal(mainMenuSection);
                    }
                }
                
                draggedObject = null;
                isDragging = false;
                orbitControls.enabled = true;
            }
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            init3DScene();
            
            const sphereGeometry = new THREE.SphereGeometry(2, 32, 32);
            const sphereMaterial = new THREE.MeshPhongMaterial({ color: 0x00FFFF, emissive: 0x00FFFF, emissiveIntensity: 0.5 });
            chatbotSphere = createShape(sphereGeometry, sphereMaterial, 'chatbot');

            const boxGeometry = new THREE.BoxGeometry(3, 3, 3);
            const boxMaterial = new THREE.MeshPhongMaterial({ color: 0xFFD700, emissive: 0xFFD700, emissiveIntensity: 0.3 });
            menuBox = createShape(boxGeometry, boxMaterial, 'menu');

            positionShapesInCorners();

            animate3D();
        };
    </script>
</body>
</html>
