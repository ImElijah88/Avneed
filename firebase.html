<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Notes Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .button {
            @apply px-4 py-2 rounded-md text-white font-semibold transition duration-200 ease-in-out;
            background-color: #4a5568;
            border: 1px solid #64748b;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }
        .button:hover:not(:disabled) {
            background-color: #64748b;
        }
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .input-field {
            @apply w-full p-2 rounded-md border border-gray-600 bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500;
            margin-bottom: 1rem;
            min-height: 80px;
            resize: vertical;
        }
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #00FFFF;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-message {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #cbd5e1;
        }
        .success-bg {
            background-color: #22c55e !important; /* Tailwind green-500 */
            border-color: #22c55e !important;
        }
        .error-bg {
            background-color: #ef4444 !important; /* Tailwind red-500 */
            border-color: #ef4444 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-2xl font-bold mb-4">Firebase Notes Tester</h1>
        
        <div class="flex flex-col mb-4">
            <button id="loginBtn" class="button">Log In (GitHub)</button>
            <button id="logoutBtn" class="button hidden">Log Out</button>
        </div>

        <h2 class="text-xl font-semibold mb-2">Your Private Notes</h2>
        <p id="notesLoginPrompt" class="text-sm text-gray-400 mb-2">
            Log in to save and load your personal notes.
        </p>
        <textarea id="userNotesInput" class="input-field" placeholder="Type your private notes here..." disabled></textarea>
        <button id="saveNotesBtn" class="button" disabled>Save Notes</button>
        <p id="userNotesStatus" class="status-message">Please log in to save notes.</p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInWithPopup, GithubAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: PASTE YOUR FIREBASE CONFIG OBJECT HERE!
        // Replace this entire 'firebaseConfig' definition with the object you copied
        // from your Firebase Console -> Project settings -> Your apps -> Web app.
        const firebaseConfig = {
          // Example (replace with your actual values):
          // apiKey: "AIzaSyD_YOUR_API_KEY",
          // authDomain: "your-project-id.firebaseapp.com",
          // projectId: "your-project-id",
          // storageBucket: "your-project-id.appspot.com",
          // messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
          // appId: "1:YOUR_APP_ID",
          // measurementId: "G-YOUR_MEASUREMENT_ID"
        };
        // END OF YOUR FIREBASE CONFIG

        // For this minimal test app, we don't need __app_id or __initial_auth_token
        // as we are testing direct deployment, not Canvas environment behavior.
        const appId = "firebase-test-app-id"; // A static ID for this test app's data in Firestore
        const initialAuthToken = null; // No custom token for direct deployment

        let app;
        let db;
        let auth;
        let userId = null;

        // Debugging line to confirm config is loaded
        console.log("Firebase Config Loaded:", firebaseConfig);

        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userNotesInput = document.getElementById('userNotesInput');
        const saveNotesBtn = document.getElementById('saveNotesBtn');
        const userNotesStatus = document.getElementById('userNotesStatus');
        const notesLoginPrompt = document.getElementById('notesLoginPrompt');

        // Initialize Firebase and set up auth listener
        document.addEventListener('DOMContentLoaded', async () => {
            // Ensure firebaseConfig is not empty and has a projectId
            if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.projectId) { 
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // For direct deployment, we don't rely on initialAuthToken.
                // The user will explicitly click "Log In (GitHub)".
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User is logged in:", userId);
                        updateLoginButtons(true);
                        loadUserNotes();
                    } else {
                        userId = null;
                        console.log("User is logged out.");
                        updateLoginButtons(false);
                        userNotesInput.value = '';
                        userNotesStatus.textContent = 'Please log in to save notes.';
                    }
                });
            } else {
                console.warn("Firebase config not found or invalid. Firebase features will be disabled.");
                loginBtn.disabled = true;
                logoutBtn.disabled = true;
                saveNotesBtn.disabled = true;
                userNotesInput.disabled = true;
                userNotesStatus.textContent = 'Firebase not configured. Please paste your config into the script.';
            }
        });

        loginBtn.addEventListener('click', async () => {
            const provider = new GithubAuthProvider();
            try {
                // This is where the GitHub login pop-up will appear
                await signInWithPopup(auth, provider);
                console.log("Signed in with GitHub!");
            } catch (error) {
                console.error("Error signing in with GitHub:", error);
                userNotesStatus.textContent = `Login Error: ${error.message}. Check console for details.`;
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("User signed out.");
            } catch (error) {
                console.error("Error signing out:", error);
                userNotesStatus.textContent = `Logout Error: ${error.message}`;
            }
        });

        saveNotesBtn.addEventListener('click', async () => {
            if (!userId) {
                userNotesStatus.textContent = 'Please log in to save notes.';
                return;
            }
            if (!db) {
                userNotesStatus.textContent = 'Firebase not initialized.';
                return;
            }

            const originalButtonText = saveNotesBtn.textContent;
            const originalButtonBg = saveNotesBtn.style.backgroundColor;
            const originalButtonBorder = saveNotesBtn.style.borderColor;

            saveNotesBtn.disabled = true;
            saveNotesBtn.innerHTML = `<span class="loading-spinner"></span> Saving...`;
            saveNotesBtn.style.backgroundColor = '#4a5568';
            saveNotesBtn.style.borderColor = '#4a5568';

            const userNotes = userNotesInput.value;
            // Notes will be saved under /artifacts/firebase-test-app-id/users/{userId}/private/notes
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private`, 'notes');

            try {
                await setDoc(userDocRef, { content: userNotes, timestamp: new Date() }, { merge: true });
                userNotesStatus.textContent = 'Notes saved successfully!';
                console.log("User notes saved.");

                saveNotesBtn.innerHTML = `Saved!`;
                saveNotesBtn.classList.add('success-bg');

            } catch (error) {
                console.error("Error saving notes:", error);
                userNotesStatus.textContent = `Error saving notes: ${error.message}`;
                
                saveNotesBtn.innerHTML = `Error!`;
                saveNotesBtn.classList.add('error-bg');

            } finally {
                setTimeout(() => {
                    saveNotesBtn.innerHTML = originalButtonText;
                    saveNotesBtn.style.backgroundColor = originalButtonBg;
                    saveNotesBtn.style.borderColor = originalButtonBorder;
                    saveNotesBtn.classList.remove('success-bg', 'error-bg');
                    saveNotesBtn.disabled = false;
                }, 1500);
            }
        });

        function loadUserNotes() {
            if (!userId || !db) {
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private`, 'notes');

            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userNotesInput.value = data.content || '';
                    userNotesStatus.textContent = 'Notes loaded.';
                } else {
                    userNotesInput.value = '';
                    userNotesStatus.textContent = 'No notes found. Start typing!';
                }
                console.log("User notes loaded/updated from Firestore.");
            }, (error) => {
                console.error("Error loading notes:", error);
                userNotesStatus.textContent = `Error loading notes: ${error.message}`;
            });
        }

        function updateLoginButtons(isLoggedIn) {
            if (isLoggedIn) {
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                userNotesInput.disabled = false;
                saveNotesBtn.disabled = false;
                notesLoginPrompt.classList.add('hidden');
            } else {
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                userNotesInput.disabled = true;
                saveNotesBtn.disabled = true;
                notesLoginPrompt.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
